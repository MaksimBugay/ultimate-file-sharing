!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).uuid={})}(this,(function(e){"use strict";var t,n=new Uint8Array(16);function a(){if(!t&&!(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(n)}var r=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function i(e){return"string"==typeof e&&r.test(e)}for(var s,o,c=[],l=0;l<256;++l)c.push((l+256).toString(16).substr(1));function u(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(c[e[t+0]]+c[e[t+1]]+c[e[t+2]]+c[e[t+3]]+"-"+c[e[t+4]]+c[e[t+5]]+"-"+c[e[t+6]]+c[e[t+7]]+"-"+c[e[t+8]]+c[e[t+9]]+"-"+c[e[t+10]]+c[e[t+11]]+c[e[t+12]]+c[e[t+13]]+c[e[t+14]]+c[e[t+15]]).toLowerCase();if(!i(n))throw TypeError("Stringified UUID is invalid");return n}var d=0,h=0;function p(e){if(!i(e))throw TypeError("Invalid UUID");var t,n=new Uint8Array(16);return n[0]=(t=parseInt(e.slice(0,8),16))>>>24,n[1]=t>>>16&255,n[2]=t>>>8&255,n[3]=255&t,n[4]=(t=parseInt(e.slice(9,13),16))>>>8,n[5]=255&t,n[6]=(t=parseInt(e.slice(14,18),16))>>>8,n[7]=255&t,n[8]=(t=parseInt(e.slice(19,23),16))>>>8,n[9]=255&t,n[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,n[11]=t/4294967296&255,n[12]=t>>>24&255,n[13]=t>>>16&255,n[14]=t>>>8&255,n[15]=255&t,n}function y(e,t,n){function a(e,a,r,i){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],n=0;n<e.length;++n)t.push(e.charCodeAt(n));return t}(e)),"string"==typeof a&&(a=p(a)),16!==a.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var s=new Uint8Array(16+e.length);if(s.set(a),s.set(e,a.length),(s=n(s))[6]=15&s[6]|t,s[8]=63&s[8]|128,r){i=i||0;for(var o=0;o<16;++o)r[i+o]=s[o];return r}return u(s)}try{a.name=e}catch(e){}return a.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",a.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",a}function f(e){return 14+(e+64>>>9<<4)+1}function C(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function g(e,t,n,a,r,i){return C((s=C(C(t,e),C(a,i)))<<(o=r)|s>>>32-o,n);var s,o}function m(e,t,n,a,r,i,s){return g(t&n|~t&a,e,t,r,i,s)}function E(e,t,n,a,r,i,s){return g(t&a|n&~a,e,t,r,i,s)}function S(e,t,n,a,r,i,s){return g(t^n^a,e,t,r,i,s)}function w(e,t,n,a,r,i,s){return g(n^(t|~a),e,t,r,i,s)}var b=y("v3",48,(function(e){if("string"==typeof e){var t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(var n=0;n<t.length;++n)e[n]=t.charCodeAt(n)}return function(e){for(var t=[],n=32*e.length,a="0123456789abcdef",r=0;r<n;r+=8){var i=e[r>>5]>>>r%32&255,s=parseInt(a.charAt(i>>>4&15)+a.charAt(15&i),16);t.push(s)}return t}(function(e,t){e[t>>5]|=128<<t%32,e[f(t)-1]=t;for(var n=1732584193,a=-271733879,r=-1732584194,i=271733878,s=0;s<e.length;s+=16){var o=n,c=a,l=r,u=i;n=m(n,a,r,i,e[s],7,-680876936),i=m(i,n,a,r,e[s+1],12,-389564586),r=m(r,i,n,a,e[s+2],17,606105819),a=m(a,r,i,n,e[s+3],22,-1044525330),n=m(n,a,r,i,e[s+4],7,-176418897),i=m(i,n,a,r,e[s+5],12,1200080426),r=m(r,i,n,a,e[s+6],17,-1473231341),a=m(a,r,i,n,e[s+7],22,-45705983),n=m(n,a,r,i,e[s+8],7,1770035416),i=m(i,n,a,r,e[s+9],12,-1958414417),r=m(r,i,n,a,e[s+10],17,-42063),a=m(a,r,i,n,e[s+11],22,-1990404162),n=m(n,a,r,i,e[s+12],7,1804603682),i=m(i,n,a,r,e[s+13],12,-40341101),r=m(r,i,n,a,e[s+14],17,-1502002290),n=E(n,a=m(a,r,i,n,e[s+15],22,1236535329),r,i,e[s+1],5,-165796510),i=E(i,n,a,r,e[s+6],9,-1069501632),r=E(r,i,n,a,e[s+11],14,643717713),a=E(a,r,i,n,e[s],20,-373897302),n=E(n,a,r,i,e[s+5],5,-701558691),i=E(i,n,a,r,e[s+10],9,38016083),r=E(r,i,n,a,e[s+15],14,-660478335),a=E(a,r,i,n,e[s+4],20,-405537848),n=E(n,a,r,i,e[s+9],5,568446438),i=E(i,n,a,r,e[s+14],9,-1019803690),r=E(r,i,n,a,e[s+3],14,-187363961),a=E(a,r,i,n,e[s+8],20,1163531501),n=E(n,a,r,i,e[s+13],5,-1444681467),i=E(i,n,a,r,e[s+2],9,-51403784),r=E(r,i,n,a,e[s+7],14,1735328473),n=S(n,a=E(a,r,i,n,e[s+12],20,-1926607734),r,i,e[s+5],4,-378558),i=S(i,n,a,r,e[s+8],11,-2022574463),r=S(r,i,n,a,e[s+11],16,1839030562),a=S(a,r,i,n,e[s+14],23,-35309556),n=S(n,a,r,i,e[s+1],4,-1530992060),i=S(i,n,a,r,e[s+4],11,1272893353),r=S(r,i,n,a,e[s+7],16,-155497632),a=S(a,r,i,n,e[s+10],23,-1094730640),n=S(n,a,r,i,e[s+13],4,681279174),i=S(i,n,a,r,e[s],11,-358537222),r=S(r,i,n,a,e[s+3],16,-722521979),a=S(a,r,i,n,e[s+6],23,76029189),n=S(n,a,r,i,e[s+9],4,-640364487),i=S(i,n,a,r,e[s+12],11,-421815835),r=S(r,i,n,a,e[s+15],16,530742520),n=w(n,a=S(a,r,i,n,e[s+2],23,-995338651),r,i,e[s],6,-198630844),i=w(i,n,a,r,e[s+7],10,1126891415),r=w(r,i,n,a,e[s+14],15,-1416354905),a=w(a,r,i,n,e[s+5],21,-57434055),n=w(n,a,r,i,e[s+12],6,1700485571),i=w(i,n,a,r,e[s+3],10,-1894986606),r=w(r,i,n,a,e[s+10],15,-1051523),a=w(a,r,i,n,e[s+1],21,-2054922799),n=w(n,a,r,i,e[s+8],6,1873313359),i=w(i,n,a,r,e[s+15],10,-30611744),r=w(r,i,n,a,e[s+6],15,-1560198380),a=w(a,r,i,n,e[s+13],21,1309151649),n=w(n,a,r,i,e[s+4],6,-145523070),i=w(i,n,a,r,e[s+11],10,-1120210379),r=w(r,i,n,a,e[s+2],15,718787259),a=w(a,r,i,n,e[s+9],21,-343485551),n=C(n,o),a=C(a,c),r=C(r,l),i=C(i,u)}return[n,a,r,i]}(function(e){if(0===e.length)return[];for(var t=8*e.length,n=new Uint32Array(f(t)),a=0;a<t;a+=8)n[a>>5]|=(255&e[a/8])<<a%32;return n}(e),8*e.length))}));function P(e,t,n,a){switch(e){case 0:return t&n^~t&a;case 1:case 3:return t^n^a;case 2:return t&n^t&a^n&a}}function I(e,t){return e<<t|e>>>32-t}var A=y("v5",80,(function(e){var t=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var a=unescape(encodeURIComponent(e));e=[];for(var r=0;r<a.length;++r)e.push(a.charCodeAt(r))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var i=e.length/4+2,s=Math.ceil(i/16),o=new Array(s),c=0;c<s;++c){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=e[64*c+4*u]<<24|e[64*c+4*u+1]<<16|e[64*c+4*u+2]<<8|e[64*c+4*u+3];o[c]=l}o[s-1][14]=8*(e.length-1)/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<s;++d){for(var h=new Uint32Array(80),p=0;p<16;++p)h[p]=o[d][p];for(var y=16;y<80;++y)h[y]=I(h[y-3]^h[y-8]^h[y-14]^h[y-16],1);for(var f=n[0],C=n[1],g=n[2],m=n[3],E=n[4],S=0;S<80;++S){var w=Math.floor(S/20),b=I(f,5)+P(w,C,g,m)+E+t[w]+h[S]>>>0;E=m,m=g,g=I(C,30)>>>0,C=f,f=b}n[0]=n[0]+f>>>0,n[1]=n[1]+C>>>0,n[2]=n[2]+g>>>0,n[3]=n[3]+m>>>0,n[4]=n[4]+E>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,255&n[0],n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,255&n[1],n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,255&n[2],n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,255&n[3],n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,255&n[4]]}));e.NIL="00000000-0000-0000-0000-000000000000",e.parse=p,e.stringify=u,e.v1=function(e,t,n){var r=t&&n||0,i=t||new Array(16),c=(e=e||{}).node||s,l=void 0!==e.clockseq?e.clockseq:o;if(null==c||null==l){var p=e.random||(e.rng||a)();null==c&&(c=s=[1|p[0],p[1],p[2],p[3],p[4],p[5]]),null==l&&(l=o=16383&(p[6]<<8|p[7]))}var y=void 0!==e.msecs?e.msecs:Date.now(),f=void 0!==e.nsecs?e.nsecs:h+1,C=y-d+(f-h)/1e4;if(C<0&&void 0===e.clockseq&&(l=l+1&16383),(C<0||y>d)&&void 0===e.nsecs&&(f=0),f>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");d=y,h=f,o=l;var g=(1e4*(268435455&(y+=122192928e5))+f)%4294967296;i[r++]=g>>>24&255,i[r++]=g>>>16&255,i[r++]=g>>>8&255,i[r++]=255&g;var m=y/4294967296*1e4&268435455;i[r++]=m>>>8&255,i[r++]=255&m,i[r++]=m>>>24&15|16,i[r++]=m>>>16&255,i[r++]=l>>>8|128,i[r++]=255&l;for(var E=0;E<6;++E)i[r+E]=c[E];return t||u(i)},e.v3=b,e.v4=function(e,t,n){var r=(e=e||{}).random||(e.rng||a)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(var i=0;i<16;++i)t[n+i]=r[i];return t}return u(r)},e.v5=A,e.validate=i,e.version=function(e){if(!i(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)},Object.defineProperty(e,"__esModule",{value:!0})}));const MemoryBlock=Object.freeze({MB:1048576,MB_ENC:1155625,MB10:10485760,MB100:104857600,GB:1073741824});class ProgressBarWidget{constructor(e,t,n){this.pbContainer=e,this.pbProgress=t,this.pbProgressPercentage=n}reset(){this.setProgress(0)}setProgress(e){this.pbProgress.value=e,this.pbProgressPercentage.textContent=`${e}%`}}function delay(e){return new Promise((t=>setTimeout(t,e)))}function isMobile(){const e=/Mobi|Android/i.test(navigator.userAgent),t=window.innerWidth<=800&&window.innerHeight<=1280,n="ontouchstart"in window||navigator.maxTouchPoints>0;return e&&t&&n}function isStringPresentNumber(e){return/^-?\d+$/.test(e.trim())}function isBase64(e){if("string"!=typeof e||0===e.length)return!1;const t=e.replace(/[-_]/g,"");if(t.length%4!=0)return!1;return/^[A-Za-z0-9+/]*={0,2}$/.test(t)}function generateStrongPassword(e=12){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n="abcdefghijklmnopqrstuvwxyz",a="0123456789",r="!@#$%^&*()-_=+[]{}|;:',.<>?",i=t+n+a+r;let s="";s+=t.charAt(Math.floor(26*Math.random())),s+=n.charAt(Math.floor(26*Math.random())),s+=a.charAt(Math.floor(10*Math.random())),s+=r.charAt(Math.floor(27*Math.random()));for(let t=4;t<e;t++)s+=i.charAt(Math.floor(Math.random()*i.length));return s=s.split("").sort((()=>Math.random()-.5)).join(""),s}function convertBlobToArrayBuffer(e){return new Promise(((t,n)=>{const a=new FileReader;a.onload=function(e){const n=e.target.result;t(n)},a.onerror=function(e){n(e)},a.readAsArrayBuffer(e)}))}function formatString(e,...t){return e.replace(/{(\d+)}/g,(function(e,n){return void 0!==t[n]?t[n]:e}))}function calculateStringHashCode(e){const t=(new TextEncoder).encode(e);let n=0;for(const e of t)n=31*n+(255&e),n|=0;return n}function stringToByteArray(e){return(new TextEncoder).encode(e)}function stringToArrayBuffer(e){return(new TextEncoder).encode(e).buffer}function arrayBufferToString(e){return new TextDecoder("utf-8").decode(e)}function byteArrayToString(e){return(new TextDecoder).decode(e)}function intToBytes(e){const t=new ArrayBuffer(4);new DataView(t).setInt32(0,e,!1);const n=new Int8Array(t);return Array.from(n)}function bytesToInt(e){if(4!==e.byteLength)throw new Error("Invalid byte array length. Must be 4 bytes.");return new DataView(e).getInt32(0,!1)}function shortIntToBytes(e){if(e<0||e>255)throw new RangeError("Integer must be in the range 0 to 255.");const t=new Uint8Array(1);return t[0]=e,t}function bytesToShortInt(e){if(1!==e.byteLength)throw new Error(`Invalid byte array length ${e.byteLength}. Must be 1 byte.`);return new DataView(e).getInt8(0)}function booleanToBytes(e){return shortIntToBytes(e?1:0)}function bytesToBoolean(e){return 1===bytesToShortInt(e)}function uuidToBytes(e){const t=uuid.parse(e),n=new ArrayBuffer(16),a=new DataView(n);for(let e=0;e<16;e++)a.setUint8(e,t[e]);let r=0n,i=0n;for(let e=0;e<8;e++)r=r<<8n|BigInt(a.getUint8(e));for(let e=8;e<16;e++)i=i<<8n|BigInt(a.getUint8(e));a.setBigUint64(0,r,!1),a.setBigUint64(8,i,!1);const s=new Int8Array(n);return Array.from(s)}function bytesToUuid(e){e=new Uint8Array(e);const t=new DataView(e.buffer),n=t.getBigUint64(0,!1),a=t.getBigUint64(8,!1),r=n.toString(16).padStart(16,"0"),i=a.toString(16).padStart(16,"0");return`${r.substring(0,8)}-${r.substring(8,12)}-${r.substring(12,16)}-${i.substring(0,4)}-${i.substring(4,16)}`}function bytesToArrayBuffer(e){const t=new ArrayBuffer(e.length);return new Uint8Array(t).set(e),t}function concatArrayBuffers(e){const t=e.reduce(((e,t)=>e+t.byteLength),0),n=new ArrayBuffer(t),a=new Uint8Array(n);let r=0;return e.forEach((e=>{const t=new Uint8Array(e);a.set(t,r),r+=e.byteLength})),n}function arrayBuffersAreEqual(e,t){if(e.byteLength!==t.byteLength)return!1;const n=new Uint8Array(e),a=new Uint8Array(t);for(let e=0;e<n.length;e++)if(n[e]!==a[e])return!1;return!0}function concatenateByteArrays(...e){let t=e.reduce(((e,t)=>e+t.length),0),n=new Uint8Array(t),a=0;return e.forEach((e=>{n.set(e,a),a+=e.length})),n}function copyBytes(e,t,n){if(t<0||n>e.byteLength||t>n)throw new RangeError("Invalid start or end index.");return e.slice(t,n)}function shiftFirstNBytes(e,t){if(t>=e.byteLength)return new ArrayBuffer(0);const n=new ArrayBuffer(e.byteLength-t),a=new Uint8Array(e);return new Uint8Array(n).set(a.subarray(t)),n}function splitArrayBuffer(e,t){const n=[],a=Math.ceil(e.byteLength/t);for(let r=0;r<a;r++){const a=r*t,i=Math.min(a+t,e.byteLength),s=e.slice(a,i);n.push(s)}return n}function popFirstNBytesFromArrayBuffer(e,t){return new Uint8Array(e).slice(0,t).buffer}function removeFirstNBytesFromArrayBuffer(e,t){return new Uint8Array(e).slice(t).buffer}function isNotEmpty(e){return null!=e&&void 0!==e&&""!==e}function isEmpty(e){return!isNotEmpty(e)}function isArrayNotEmpty(e){return null!=e&&Array.isArray(e)&&e.length>0}function isArrayEmpty(e){return!isNotEmpty(e)}function extractNumber(e){const t=e.match(/\d+/);return t?parseInt(t[0],10):null}function printDateTime(e){const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}function printPreciseDateTime(e){const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`}function printObject(e){return Object.values(e).filter((e=>null!=e)).join("/")}function encodeToBase64UrlSafe(e){const t=(new TextEncoder).encode(e),n=String.fromCharCode.apply(null,t);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function decodeFromBase64UrlSafe(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";const n=atob(t),a=new Uint8Array(n.length);for(let e=0;e<n.length;e++)a[e]=n.charCodeAt(e);return(new TextDecoder).decode(a)}async function blobToArrayBuffers(e,t){const n=[],a=e.size;let r=0;for(;r<a;){const a=e.slice(r,r+t),i=await a.arrayBuffer();n.push(i),r+=t}return n}function getFileExtension(e){const t=e.split(".");return t.length>1?t.pop():""}function downloadFile(e,t){const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}function hasParentWithIdOrClass(e,t){if(!(e instanceof Element&&Array.isArray(t)&&0!==t.length))return!1;for(let n=0;n<t.length;n++){let a=e.closest(`#${t[n]}`);if(a)return!0;if(a=e.closest(`.${t[n]}`),a)return!0}return!1}function swapElements(e,t){if(!e||!t)return void console.error("One or both elements not found.");const n=document.createElement("div");e.parentNode.insertBefore(n,e),t.parentNode.insertBefore(e,t),n.parentNode.insertBefore(t,n),n.parentNode.removeChild(n)}function printAllParents(e,t){const n=t||1e3;let a=e.parentElement,r=0;for(;a;){if(r+=1,console.log(`Parent: level=${r}, height=${a.getBoundingClientRect().height}`),console.log(a),r>n)return;a=a.parentElement}}function getCountryWithFlagInnerHtml(e,t){return`<div style="display: flex"> <img style="margin-right: 10px; border: 1px solid black;" src="${`https://flagcdn.com/w40/${e.toLowerCase()}.png`}" alt="Estonia Flag" /> ${t}</div>`}function getCountryFlagImage(e){const t={en:"us",es:"es",fr:"fr",de:"de",zh:"cn",ru:"ru",ja:"jp",it:"it",pt:"pt",ar:"sa",hi:"in",ko:"kr",tr:"tr",nl:"nl",sv:"se",pl:"pl",vi:"vn",id:"id",th:"th",uk:"ua",ms:"my",tl:"ph",fa:"ir",ro:"ro",hu:"hu",cs:"cz",el:"gr",da:"dk",fi:"fi",no:"no"}[e];return t?`<img src="https://flagcdn.com/${t}.svg" alt="${e}" class="flag">`:'<span class="flag">üè≥Ô∏è</span>'}async function requestWakeLock(e){if(isMobile())try{e.wakeLock=await navigator.wakeLock.request("screen"),console.log("Wake lock is active."),e.wakeLock.addEventListener("release",(()=>{console.log("Wake lock was released.")}))}catch(e){console.error(`Failed to request wake lock: ${e.message}`)}}function releaseWakeLock(e){isMobile()&&null!==e.wakeLock&&e.wakeLock.release().then((()=>{e.wakeLock=null,console.log("Wake lock has been released.")}))}function calculateVisibilityData(e){if(!e||!e.getBoundingClientRect)return null;const t=e.getBoundingClientRect(),n=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),a=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0),r=Math.max(0,t.left),i=Math.max(0,t.top),s=Math.min(n,t.right),o=Math.min(a,t.bottom),c=Math.max(0,s-r),l=Math.max(0,o-i),u=t.width||t.right-t.left,d=t.height||t.bottom-t.top;if(u<=0||d<=0)return{rect:t,visibilityRatio:0,visibilityPercentage:0,isVisible:!1,viewportWidth:n,viewportHeight:a};const h=c*l/(u*d);return{rect:t,visibilityRatio:h,visibilityPercentage:Math.round(100*h),isVisible:h>0,viewportWidth:n,viewportHeight:a}}function isElementFullyVisible(e,t){t||(t={});const n="number"==typeof t.threshold?t.threshold:1,a="number"==typeof t.rootMargin?t.rootMargin:0,r=calculateVisibilityData(e);if(!r)return console.warn("Invalid element provided to isElementFullyVisible"),!1;if(0!==a){const e={top:r.rect.top+a,left:r.rect.left+a,bottom:r.rect.bottom-a,right:r.rect.right-a};return e.top>=0&&e.left>=0&&e.bottom<=r.viewportHeight&&e.right<=r.viewportWidth&&r.visibilityRatio>=n}return r.visibilityRatio>=n}function observeElementVisibility(e,t,n){if(n||(n={}),!window.IntersectionObserver){console.warn("IntersectionObserver not supported, using fallback method");const a=function(){const a=isElementFullyVisible(e,n);t(a,e)},r=setInterval(a,100);return a(),{disconnect:function(){clearInterval(r)},unobserve:function(){clearInterval(r)}}}const a=new IntersectionObserver((function(e){e.forEach((function(e){const a=e.intersectionRatio>=(n.threshold||1);t(a,e.target,e)}))}),{threshold:n.threshold||1,rootMargin:n.rootMargin||"0px"});return a.observe(e),a}function isFullyVisible(e){return"string"==typeof e&&(e=document.querySelector(e)),isElementFullyVisible(e)}function isPartiallyVisible(e){return"string"==typeof e&&(e=document.querySelector(e)),isElementFullyVisible(e,{threshold:0})}function getVisibilityPercentage(e){"string"==typeof e&&(e=document.querySelector(e));const t=calculateVisibilityData(e);return t?t.visibilityPercentage:0}function getVisibilityInfo(e){return"string"==typeof e&&(e=document.querySelector(e)),calculateVisibilityData(e)}function isImageContentType(e){return e&&e.startsWith("image")}function isVideoContentType(e){return e&&e.startsWith("video")}function isImageFile(e){return e&&e instanceof File&&isImageContentType(e.type)}function isVideoFile(e){return e&&e instanceof File&&isVideoContentType(e.type)}console.log("callable-future.js running on",window.location.href);const CallableFuture={},WaiterResponseType=Object.freeze({SUCCESS:"SUCCESS",ERROR:"ERROR"});class Waiter{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class WaiterResponse{constructor(e,t){this.type=e,this.body=t}}CallableFuture.releaseWaiterWithSuccess=function(e,t){e.resolve(new WaiterResponse(WaiterResponseType.SUCCESS,t))},CallableFuture.releaseWaiterWithError=function(e,t){e.reject(new WaiterResponse(WaiterResponseType.ERROR,t))},CallableFuture.waitingHall=new Map,CallableFuture.addToWaitingHall=function(e){let t=new Waiter;return CallableFuture.waitingHall.set(e,t),t.promise},CallableFuture.releaseWaiterIfExistsWithSuccess=function(e,t){let n=CallableFuture.waitingHall.get(e);return!!n&&(CallableFuture.releaseWaiterWithSuccess(n,t),CallableFuture.waitingHall.delete(e),!0)},CallableFuture.releaseWaiterIfExistsWithError=function(e,t){let n=CallableFuture.waitingHall.get(e);n&&(CallableFuture.releaseWaiterWithError(n,t),CallableFuture.waitingHall.delete(e))},CallableFuture.callAsynchronouslyWithRepeatOfFailure=async function(e,t,n,a,r=!1){let i;for(let s=0;s<n;s++){if(r&&PushcaClient.uploadBinaryLimitWasReached)return new WaiterResponse(WaiterResponseType.ERROR,"uploadBinaryLimitWasReached");if(i=await CallableFuture.callAsynchronously(e,t,a),WaiterResponseType.SUCCESS===i.type)return i}return i},CallableFuture.callAsynchronously=async function(e,t,n){const a=e||1e3;const r=t||uuid.v4().toString();let i;"function"==typeof n&&n(r);try{i=await Promise.race([CallableFuture.addToWaitingHall(r),(s=a,new Promise(((e,t)=>{setTimeout((()=>t(new Error("Timeout after "+s+" ms"))),s)})))])}catch(e){CallableFuture.waitingHall.delete(r),i=new WaiterResponse(WaiterResponseType.ERROR,e)}var s;return i};const JoinTransferGroupResponse=Object.freeze({DENIED:"DENIED",ERROR:"ERROR"});class CreatePrivateUrlSuffixRequest{constructor(e,t){this.workspaceId=e,this.binaryId=t}}class JoinTransferGroupRequest{constructor(e,t,n,a){this.deviceId=e,this.sessionId=t,this.publicKeyStr=n,this.binaryId=a}cloneAndReplacePublicKey(e){return new JoinTransferGroupRequest(this.deviceId,this.sessionId,e,this.binaryId)}static fromJsonString(e){const t="string"==typeof e?JSON.parse(e):e;return new JoinTransferGroupRequest(t.deviceId,t.sessionId,t.publicKeyStr,t.binaryId)}}class DownloadProtectedBinaryRequest{constructor(e,t,n,a,r){this.suffix=e,this.exp=t,this.signature=n,this.binaryId=a,this.passwordHash=r}toSkipSignatureJSON(){return{suffix:this.suffix,exp:this.exp}}static fromJsonString(e){const t="string"==typeof e?JSON.parse(e):e;return new DownloadProtectedBinaryRequest(t.suffix,t.exp,t.signature,t.binaryId)}}class EncryptionContract{constructor(e,t){this.base64Key=e,this.base64IV=t}async toTransferableString(e,t){const n=await encryptPrivateKey(this.base64Key,this.base64IV,e,t);return encodeToBase64UrlSafe(JSON.stringify({base64Key:n,base64IV:this.base64IV}))}static async fromTransferableString(e,t,n){const a=decodeFromBase64UrlSafe(e),r="string"==typeof a?JSON.parse(a):a,i=await decryptPrivateKey(r.base64Key,t,n,r.base64IV);return new EncryptionContract(i,r.base64IV)}}async function calculateSignatureSha256(e){const t=(new TextEncoder).encode(e),n=await window.crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}async function calculateSha256(e){const t=await crypto.subtle.digest("SHA-256",e),n=Array.from(new Uint8Array(t));return btoa(String.fromCharCode.apply(null,n))}async function generateKeyFromPassword(e,t){const n=new TextEncoder,a=await crypto.subtle.importKey("raw",n.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},a,{name:"HMAC",hash:"SHA-256",length:256},!0,["sign","verify"])}async function generateAESKeyFromPassword(e,t){const n=new TextEncoder,a=await crypto.subtle.importKey("raw",n.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function verifySignatureWithKey(e,t,n){const a=(new TextEncoder).encode(t),r=urlSafeBase64ToArrayBuffer(n);return await crypto.subtle.verify("HMAC",e,r,a)}async function makeSignature(e,t,n){const a=await generateKeyFromPassword(e,t);return await signString(a,n)}async function verifySignature(e,t,n,a){const r=await generateKeyFromPassword(e,t);return await verifySignatureWithKey(r,n,a)}async function signString(e,t){const n=(new TextEncoder).encode(t);return await crypto.subtle.sign("HMAC",e,n)}async function createPrivateUrlSuffix(e,t){const n=await fetch(PushcaClient.clusterBaseUrl+"/binary/private/create-url-suffix",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(new CreatePrivateUrlSuffixRequest(e,t))});return n.ok?n.text():(console.error("Failed create private URL suffix request "+n.statusText),null)}function byteArrayToBase64(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return window.btoa(t)}function arrayBufferToBase64(e){let t="";const n=new Uint8Array(e),a=n.byteLength;for(let e=0;e<a;e++)t+=String.fromCharCode(n[e]);return window.btoa(t)}function arrayBufferToUrlSafeBase64(e){return arrayBufferToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function base64ToArrayBuffer(e){const t=window.atob(e),n=t.length,a=new Uint8Array(n);for(let e=0;e<n;e++)a[e]=t.charCodeAt(e);return a.buffer}function urlSafeBase64ToArrayBuffer(e){const t=e.replace(/-/g,"+").replace(/_/g,"/");return base64ToArrayBuffer(t.padEnd(t.length+(4-t.length%4)%4,"="))}async function generateEncryptionContract(){const e=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),t=window.crypto.getRandomValues(new Uint8Array(12)),n=await crypto.subtle.exportKey("raw",e);return new EncryptionContract(arrayBufferToBase64(n),arrayBufferToBase64(t))}async function encryptWithAES(e){const t=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),n=window.crypto.getRandomValues(new Uint8Array(12)),a=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e),r=await crypto.subtle.exportKey("raw",t);return{encryptionContract:new EncryptionContract(arrayBufferToBase64(r),arrayBufferToBase64(n)),data:new Blob([new Uint8Array(a)],{type:"application/octet-stream"}),dataBase64:arrayBufferToBase64(a)}}async function encryptWithAESUsingContract(e,t){const n=base64ToArrayBuffer(t.base64Key),a=base64ToArrayBuffer(t.base64IV),r=await crypto.subtle.importKey("raw",n,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},r,e)}async function encryptBinaryChunk(e,t,n=MemoryBlock.MB_ENC,a=0){const r=await encryptWithAESUsingContract(e,t),i=concatArrayBuffers([bytesToArrayBuffer(intToBytes(r.byteLength)),r]);if(i.byteLength>n)return alert("Encrypted block is too big!!!"),i;if(i.byteLength===n)return i;const s=new ArrayBuffer(n),o=new Uint8Array(s),c=new Uint8Array(i);return o.set(c),o.fill(a,i.byteLength),s}async function encryptSlicesWithAES(e){return await encryptWithAES(concatArrayBuffers(e))}async function decryptBinaryChunk(e,t,n=4){if(e.byteLength<n)throw new Error("Buffer is too small to contain the length integer.");const a=bytesToInt(e.slice(0,n));if(a>e.byteLength-n)throw new Error("Invalid length or buffer, it is too small for the given length.");const r=new ArrayBuffer(a),i=new Uint8Array(r),s=new Uint8Array(e);return i.set(s.slice(n,n+a)),await decryptAESToArrayBuffer(r,t.base64Key,t.base64IV)}async function decryptAESToArrayBuffer(e,t,n){const a=await crypto.subtle.importKey("raw",base64ToArrayBuffer(t),{name:"AES-GCM"},!1,["decrypt"]),r=base64ToArrayBuffer(n);try{return await crypto.subtle.decrypt({name:"AES-GCM",iv:r},a,e)}catch(e){console.error("Error during decryption:",e)}}async function decryptChunkByChunk(e,t){const n=[],a=concatArrayBuffers(e);if(a.byteLength<MemoryBlock.MB_ENC)throw new Error("Buffer is too small to contain encrypted block.");const r=splitArrayBuffer(a,MemoryBlock.MB_ENC);for(let e=0;e<r.length;e++){const a=await decryptBinaryChunk(r[e],t);n.push(a)}return new Blob(n,{type:"application/octet-stream"})}async function decryptAES(e,t,n,a="application/octet-stream"){const r=concatArrayBuffers(e),i=await decryptAESToArrayBuffer(r,t,n);return new Blob([new Uint8Array(i)],{type:a})}async function encryptPrivateKey(e,t,n,a){const r=base64ToArrayBuffer(e),i=base64ToArrayBuffer(t),s=await generateAESKeyFromPassword(n,a);return arrayBufferToBase64(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:i},s,r))}async function decryptPrivateKey(e,t,n,a){const r=base64ToArrayBuffer(e),i=base64ToArrayBuffer(a),s=await generateAESKeyFromPassword(t,n);return arrayBufferToBase64(await window.crypto.subtle.decrypt({name:"AES-GCM",iv:i},s,r))}async function generateRSAKeyPair(){return await crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},!0,["encrypt","decrypt"])}async function encryptWithPublicKey(e,t){const n=(new TextEncoder).encode(t),a=await crypto.subtle.encrypt({name:"RSA-OAEP"},e,n);return btoa(String.fromCharCode(...new Uint8Array(a)))}async function decryptWithPrivateKey(e,t){const n=Uint8Array.from(atob(t),(e=>e.charCodeAt(0))),a=await crypto.subtle.decrypt({name:"RSA-OAEP"},e,n);return(new TextDecoder).decode(a)}async function exportPublicKey(e){const t=await crypto.subtle.exportKey("spki",e);return btoa(String.fromCharCode(...new Uint8Array(t)))}async function importPublicKeyFromString(e){const t=Uint8Array.from(atob(e),(e=>e.charCodeAt(0)));return crypto.subtle.importKey("spki",t.buffer,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"])}console.log("pnotifications.js running on",window.location.href);const requiredClientFields=["workSpaceId","accountId","deviceId","applicationId"],Command=Object.freeze({PING:"PING",ACKNOWLEDGE:"ACKNOWLEDGE",SEND_MESSAGE:"SEND_MESSAGE",SEND_MESSAGE_WITH_ACKNOWLEDGE:"SEND_MESSAGE_WITH_ACKNOWLEDGE",ADD_MEMBERS_TO_CHANNEL:"ADD_MEMBERS_TO_CHANNEL",SEND_MESSAGE_TO_CHANNEL:"SEND_MESSAGE_TO_CHANNEL",GET_CHANNEL_HISTORY:"GET_CHANNEL_HISTORY",REMOVE_ME_FROM_CHANNEL:"REMOVE_ME_FROM_CHANNEL",GET_CHANNELS:"GET_CHANNELS",GET_CHANNELS_PUBLIC_INFO:"GET_CHANNELS_PUBLIC_INFO",MARK_CHANNEL_AS_READ:"MARK_CHANNEL_AS_READ",GET_IMPRESSION_STAT:"GET_IMPRESSION_STAT",ADD_IMPRESSION:"ADD_IMPRESSION",REMOVE_IMPRESSION:"REMOVE_IMPRESSION",SEND_UPLOAD_BINARY_APPEAL:"SEND_UPLOAD_BINARY_APPEAL",SEND_DELETE_BINARY_APPEAL:"SEND_DELETE_BINARY_APPEAL",SEND_BINARY_MANIFEST:"SEND_BINARY_MANIFEST",SEND_GATEWAY_RESPONSE:"SEND_GATEWAY_RESPONSE",SEND_GATEWAY_REQUEST:"SEND_GATEWAY_REQUEST",CONNECTION_ALIAS_LOOKUP:"CONNECTION_ALIAS_LOOKUP",CAPTCHA_VERIFY:"CAPTCHA_VERIFY",PUZZLE_CAPTCHA_GENERATE_AND_SEND:"PUZZLE_CAPTCHA_GENERATE_AND_SEND",PUZZLE_CAPTCHA_VERIFY_SELECTED_OPTION:"PUZZLE_CAPTCHA_VERIFY_SELECTED_OPTION",PUZZLE_CAPTCHA_VERIFY:"PUZZLE_CAPTCHA_VERIFY"}),MessageType=Object.freeze({ACKNOWLEDGE:"ACKNOWLEDGE",RESPONSE:"RESPONSE",CHANNEL_MESSAGE:"CHANNEL_MESSAGE",CHANNEL_EVENT:"CHANNEL_EVENT",UPLOAD_BINARY_APPEAL:"UPLOAD_BINARY_APPEAL",BINARY_MANIFEST:"BINARY_MANIFEST",GATEWAY_REQUEST:"GATEWAY_REQUEST",PRIVATE_URL_SUFFIX:"PRIVATE_URL_SUFFIX",CONNECTION_ALIAS:"CONNECTION_ALIAS",HUMAN_TOKEN:"HUMAN_TOKEN"}),ResourceType=Object.freeze({CHANNEL:"CHANNEL",CHANNEL_MESSAGE:"CHANNEL_MESSAGE"}),MessagePartsDelimiter="@@";class PChannel{constructor(e,t){this.id=e,this.name=t}}class ClientFilter{constructor(e,t,n,a,r,i,s,o){this.workSpaceId=e,this.accountId=t,this.deviceId=n,r&&(this.deviceId=JSON.stringify({deviceId:n,avatarCode:r,webSite:o,signatureHash:s,modalView:i,time:(new Date).getTime()})),this.applicationId=a}hashCode(){return calculateStringHashCode(formatString("{0}@@{1}@@{2}@@{3}",this.workSpaceId,this.accountId,this.deviceId,this.applicationId))}equals(e){return this.hashCode()===e.hashCode()}toJSON(e){return e?{workSpaceId:this.workSpaceId,accountId:this.accountId,deviceId:this.deviceId,applicationId:this.applicationId,findAny:!0===e}:{workSpaceId:this.workSpaceId,accountId:this.accountId,deviceId:this.deviceId,applicationId:this.applicationId}}cloneWithoutDeviceId(){return new ClientFilter(this.workSpaceId,this.accountId,null,this.applicationId)}cloneAndReplaceDeviceId(e){return new ClientFilter(this.workSpaceId,this.accountId,e,this.applicationId)}}class ChannelMember{constructor(e,t,n,a,r){this.workSpaceId=e,this.accountId=t,this.deviceId=n,this.applicationId=a,this.active=r}shortPrint(){return isNotEmpty(this.active)&&this.active?this.accountId+"[+]":this.accountId+"[-]"}}class ChannelWithInfo{constructor(e,t,n,a,r){this.channel=e,this.members=t,this.counter=n,this.time=a,this.read=r}static fromObject(e){const t=new PChannel(e.channel.id,e.channel.name);let n=[];return e.members&&(n=e.members.map((e=>new ChannelMember(e.workSpaceId,e.accountId,e.deviceId,e.applicationId,e.active)))),new ChannelWithInfo(t,n,e.counter,e.time,e.read)}}class ChannelsResponse{constructor(e){this.channels=e}static fromWsResponse(e){const t=("string"==typeof e?JSON.parse(e):e).body.channels.map((e=>ChannelWithInfo.fromObject(e)));return new ChannelsResponse(t)}}class ImpressionCounter{constructor(e,t){this.code=e,this.counter=t}static fromObject(e){return new ImpressionCounter(e.code,e.counter)}shortPrint(){return this.code+": "+this.counter}}class ResourceImpressionCounters{constructor(e,t){this.resourceId=e,this.counters=t}static fromObject(e){const t=e.counters.map((e=>ImpressionCounter.fromObject(e)));return new ResourceImpressionCounters(e.resourceId,t)}}class PImpression{constructor(e,t,n){this.resourceId=e,this.resourceType=t,this.code=n}}class ImpressionsResponse{constructor(e){this.items=e}static fromWsResponse(e){const t=("string"==typeof e?JSON.parse(e):e).body.map((e=>ResourceImpressionCounters.fromObject(e)));return new ImpressionsResponse(t)}}class HistoryPage{constructor(e,t,n,a){this.messages=e,this.offset=t,this.latest=n,this.more=a}static fromWsResponse(e){const t="string"==typeof e?JSON.parse(e):e,n=t.body.messages.map((e=>ChannelMessage.fromObject(e)));return new HistoryPage(n,t.body.offset,t.body.latest,t.body.more)}}class MessageDetails{constructor(e){this.id=e}static fromWsResponse(e){const t=("string"==typeof e?JSON.parse(e):e).body.messageId;return new MessageDetails(t)}}class ChannelEvent{constructor(e,t,n,a,r){this.type=e,this.actor=t,this.channelId=n,this.filters=a,this.time=r}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e,n=new ClientFilter(t.actor.workSpaceId,t.actor.accountId,t.actor.deviceId,t.actor.applicationId);let a=[];return t.filters&&(a=t.filters.map((e=>new ClientFilter(e.workSpaceId,e.accountId,e.deviceId,e.applicationId)))),new ChannelEvent(t.type,n,t.channelId,a,t.time)}}class ChannelMessage{constructor(e,t,n,a,r,i,s){this.sender=e,this.channelId=t,this.messageId=n||uuid.v4().toString(),this.parentId=a,this.sendTime=r||Date.now(),this.body=i,this.mentioned=s}static fromObject(e){const t=new ClientFilter(e.sender.workSpaceId,e.sender.accountId,e.sender.deviceId,e.sender.applicationId);let n=[];return isArrayNotEmpty(e.mentioned)&&(n=e.mentioned.map((e=>new ClientFilter(e.workSpaceId,e.accountId,e.deviceId,e.applicationId)))),new ChannelMessage(t,e.channelId,e.messageId,e.parentId,e.sendTime,e.body,n)}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e;return this.fromObject(t)}}class CommandWithId{constructor(e,t){this.id=e,this.message=t}}class OpenConnectionRequest{constructor(e,t,n,a){this.client=e,this.pusherInstanceId=n,this.apiKey=a,this.mobile=t}}class OpenConnectionResponse{constructor(e,t,n,a){this.pusherInstanceId=e,this.externalAdvertisedUrl=t,this.internalAdvertisedUrl=n,this.browserAdvertisedUrl=a}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e;return new OpenConnectionResponse(t.pusherInstanceId,t.externalAdvertisedUrl,t.internalAdvertisedUrl,t.browserAdvertisedUrl)}}class UploadBinaryAppeal{constructor(e,t,n,a,r,i){this.sender=e,this.owner=t,this.binaryId=n,this.chunkSize=a||MemoryBlock.MB,this.manifestOnly=r,this.requestedChunks=i}static fromObject(e){const t=new ClientFilter(e.sender.workSpaceId,e.sender.accountId,e.sender.deviceId,e.sender.applicationId),n=new ClientFilter(e.owner.workSpaceId,e.owner.accountId,e.owner.deviceId,e.owner.applicationId);return new UploadBinaryAppeal(t,n,e.binaryId,e.chunkSize,e.manifestOnly,e.requestedChunks)}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e;return this.fromObject(t)}}class GatewayRequestHeader{constructor(e,t,n,a,r,i,s,o,c,l){this.alias=e,this.client=t,this.roles=n||[],this.ip=a,this.latitude=r,this.longitude=i,this.countryCode=s,this.countryName=o,this.city=c,this.proxyInfo=l}static fromObject(e){const t=new ClientFilter(e.client.workSpaceId,e.client.accountId,e.client.deviceId,e.client.applicationId);return new GatewayRequestHeader(e.alias,t,e.roles,e.ip,e.latitude,e.longitude,e.countryCode,e.countryName,e.city,e.proxyInfo)}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e;return this.fromObject(t)}}class ClientWithAlias{constructor(e,t,n,a,r,i,s,o,c){this.client=e,this.alias=t,this.ip=n,this.latitude=a,this.longitude=r,this.countryCode=i,this.countryName=s,this.city=o,this.proxyInfo=c}static fromObject(e){const t=new ClientFilter(e.body.client.workSpaceId,e.body.client.accountId,e.body.client.deviceId,e.body.client.applicationId);return new ClientWithAlias(t,e.body.alias,e.body.ip,e.body.latitude,e.body.longitude,e.body.countryCode,e.body.countryName,e.body.city,e.body.proxyInfo)}static fromJSON(e){const t="string"==typeof e?JSON.parse(e):e;return this.fromObject(t)}}let PushcaClient={};function allClientFieldsAreNotEmpty(e){return requiredClientFields.every((t=>e.hasOwnProperty(t)&&null!==e[t]&&void 0!==e[t]&&""!==e[t]))}function cleanRefreshBrokenConnectionInterval(){PushcaClient.refreshBrokenConnectionIntervalId&&(window.clearInterval(PushcaClient.refreshBrokenConnectionIntervalId),PushcaClient.refreshBrokenConnectionIntervalId=null)}async function getAuthorizedWsUrl(e,t,n){const a=new OpenConnectionRequest(t,isMobile(),null,n),r=`${e}/sign-in/${encodeToBase64UrlSafe(JSON.stringify(a))}`;return console.log("Public sign-in url: "+r),await CallableFuture.callAsynchronously(3e3,null,(function(e){const t=new WebSocket(r);t?(t.onmessage=function(t){try{const n=OpenConnectionResponse.fromJSON(t.data);PushcaClient.pusherInstanceId=n.pusherInstanceId,CallableFuture.releaseWaiterIfExistsWithSuccess(e,n.browserAdvertisedUrl),console.log("Authorised web socket url: "+n.browserAdvertisedUrl)}catch(t){CallableFuture.releaseWaiterIfExistsWithError(e,t)}},t.onerror=function(t){CallableFuture.releaseWaiterIfExistsWithError(e,t)},t.onclose=function(t){delay(500).then((()=>{CallableFuture.releaseWaiterIfExistsWithError(e,"Failed public sign-in attempt")}))}):CallableFuture.releaseWaiterIfExistsWithError(e,"Impossible to create web socket")}))}function initConnectionRecoveryInterval(e){cleanRefreshBrokenConnectionInterval(),PushcaClient.permanentlyStopped||delay(5e3).then((()=>{PushcaClient.refreshBrokenConnectionIntervalId=window.setInterval((function(){PushcaClient.permanentlyStopped||(PushcaClient.ws&&PushcaClient.ws.readyState===window.WebSocket.OPEN?BinaryWaitingHall.forEach(((e,t)=>{e.isExpired()&&(BinaryWaitingHall.delete(t),console.log(`Expired binary with id = ${e.id} was removed from waiting hall`))})):PushcaClient.restoreWsConnection(e).then((()=>{console.log(`Ws connection was successfully restored [${PushcaClient.permanentlyStopped}]`)})))}),5e3)}))}function refreshClientObj(e){const t=JSON.parse(e.deviceId);return new ClientFilter(e.workSpaceId,e.accountId,JSON.stringify({deviceId:t.deviceId,avatarCode:t.avatarCode,webSite:t.webSite,signatureHash:t.signatureHash,modalView:t.modalView,time:(new Date).getTime()}),e.applicationId)}PushcaClient.clusterBaseUrl="https://secure.fileshare.ovh",PushcaClient.serverBaseUrl="http://localhost:8080",PushcaClient.pusherInstanceId=null,PushcaClient.verbose=!1,PushcaClient.uploadBinaryLimitWasReached=!1,PushcaClient.onOpenHandler=null,PushcaClient.onCloseHandler=null,PushcaClient.onMessageHandler=null,PushcaClient.onChannelEventHandler=null,PushcaClient.onChannelMessageHandler=null,PushcaClient.onHumanTokenHandler=null,PushcaClient.onDataHandler=null,PushcaClient.onFileTransferChunkHandler=null,PushcaClient.onCaptchaSetHandler=null,PushcaClient.onPuzzleCaptchaSetHandler=null,PushcaClient.onUploadBinaryAppealHandler=null,PushcaClient.onBinaryManifestHandler=null,PushcaClient.onFinalizedBinaryHandler=null,PushcaClient.executeWithRepeatOnFailure=async function(e,t,n,a){if(isEmpty(PushcaClient.ws))return new WaiterResponse(WaiterResponseType.ERROR,"Web socket connection does not exists");if(PushcaClient.ws.readyState!==window.WebSocket.OPEN){const e=`WebSocket is not open. State: ${PushcaClient.ws.readyState}`;return console.error(e),new WaiterResponse(WaiterResponseType.ERROR,e)}let r=a||3,i=n||5e3,s=e||t.id;return await CallableFuture.callAsynchronouslyWithRepeatOfFailure(i,s,r,(function(e){PushcaClient.ws.send(t.message)}))},PushcaClient.buildCommandMessage=function(e,t){let n,a=uuid.v4().toString();return n=t?`${a}@@${e}@@${JSON.stringify(t)}`:`${a}@@${e}`,new CommandWithId(a,n)},PushcaClient.openWebSocket=function(e,t,n){try{PushcaClient.ws=new window.WebSocket(PushcaClient.wsUrl)}catch(e){PushcaClient.ws=null,console.error(`Impossible to create web socket: ws url = ${PushcaClient.wsUrl}`,e),"function"==typeof t&&t(e)}PushcaClient.ws&&(PushcaClient.ws.binaryType="arraybuffer",PushcaClient.ws.onopen=function(){"function"==typeof e&&e(),"function"==typeof PushcaClient.onOpenHandler&&PushcaClient.onOpenHandler(PushcaClient.ws)},PushcaClient.ws.onmessage=function(e){if(e.data instanceof ArrayBuffer){const t=e.data;if(13===t.byteLength)return void PushcaClient.ws.send(t);const n=new BinaryWithHeader(t);n.withAcknowledge&&PushcaClient.sendAcknowledge(n.getId());const a=CallableFuture.releaseWaiterIfExistsWithSuccess(buildDownloadWaiterId(n.getId()),n.payload),r=CallableFuture.releaseWaiterIfExistsWithSuccess(buildSingleChunkDownloadWaiterId(n.getId()),n.payload);if(!a&&!r){const e=BinaryWaitingHall.get(buildDownloadWaiterId(n.binaryId));e&&BinaryType.FILE===n.binaryType?e.setChunkBytes(n.order,n.payload).then((()=>{e.isFinalized()&&"function"==typeof PushcaClient.onFinalizedBinaryHandler&&(PushcaClient.onFinalizedBinaryHandler(e),delay(9e5).then((()=>{BinaryWaitingHall.delete(e.id)})))})):BinaryType.FILE_TRANSFER===n.binaryType?"function"==typeof PushcaClient.onFileTransferChunkHandler&&PushcaClient.onFileTransferChunkHandler(n):BinaryType.CAPTCHA_SET===n.binaryType?"function"==typeof PushcaClient.onCaptchaSetHandler&&PushcaClient.onCaptchaSetHandler(n):BinaryType.PUZZLE_CAPTCHA_SET===n.binaryType?"function"==typeof PushcaClient.onPuzzleCaptchaSetHandler&&PushcaClient.onPuzzleCaptchaSetHandler(n):console.warn(`Unassigned binary chunk was received: binaryId = ${n.binaryId}, order = ${n.order}`)}return void("function"==typeof PushcaClient.onDataHandler&&PushcaClient.onDataHandler(e.data))}if("PONG"===e.data)return void(PushcaClient.verbose&&console.log(e.data));let t=e.data.split("@@");if(t[1]!==MessageType.ACKNOWLEDGE){if(t[1]===MessageType.RESPONSE){let e;return t.length>2&&(e=t[2]),void CallableFuture.releaseWaiterIfExistsWithSuccess(t[0],e)}if(t[1]!==MessageType.CHANNEL_EVENT)if(t[1]!==MessageType.CHANNEL_MESSAGE)if(t[1]!==MessageType.CONNECTION_ALIAS)if(t[1]!==MessageType.HUMAN_TOKEN){if(t[1]===MessageType.UPLOAD_BINARY_APPEAL)return processUploadBinaryAppeal(UploadBinaryAppeal.fromJSON(t[2])),void("function"==typeof PushcaClient.onUploadBinaryAppealHandler&&PushcaClient.onUploadBinaryAppealHandler(UploadBinaryAppeal.fromJSON(t[2])));if(t[1]===MessageType.BINARY_MANIFEST){PushcaClient.sendAcknowledge(t[0]);const e=BinaryManifest.fromJSON(t[2]),n=buildDownloadWaiterId(e.id);return CallableFuture.releaseWaiterIfExistsWithSuccess(n,e)||(BinaryWaitingHall.get(n)?console.warn(`Manifest of binary with id ${e.id} is already in processing`):BinaryWaitingHall.set(n,e)),void("function"==typeof PushcaClient.onBinaryManifestHandler&&PushcaClient.onBinaryManifestHandler(BinaryManifest.fromJSON(t[2])))}if(t[1]===MessageType.GATEWAY_REQUEST){const e=t[2],n=GatewayRequestHeader.fromJSON(t[3]);let a=new Uint8Array(0);return 5===t.length&&(a=base64ToArrayBuffer(t[4])),void processGateWayRequest(e,n,a,(function(e){let n=new Uint8Array(0);e&&(n=e),PushcaClient.sendGatewayResponse(t[0],n)}))}if(2===t.length)return PushcaClient.sendAcknowledge(t[0]),void("function"==typeof PushcaClient.onMessageHandler&&PushcaClient.onMessageHandler(PushcaClient.ws,t[1]));"function"==typeof PushcaClient.onMessageHandler&&PushcaClient.onMessageHandler(PushcaClient.ws,e.data)}else"function"==typeof PushcaClient.onHumanTokenHandler&&PushcaClient.onHumanTokenHandler(t[2]);else CallableFuture.releaseWaiterIfExistsWithSuccess(t[2],t[3]);else"function"==typeof PushcaClient.onChannelMessageHandler&&PushcaClient.onChannelMessageHandler(ChannelMessage.fromJSON(t[2]));else"function"==typeof PushcaClient.onChannelEventHandler&&PushcaClient.onChannelEventHandler(ChannelEvent.fromJSON(t[2]))}else CallableFuture.releaseWaiterIfExistsWithSuccess(t[0],null)},PushcaClient.ws.onerror=function(e){console.error("There was an error with your websocket!"),"function"==typeof t&&t(e)},PushcaClient.ws.onclose=function(e){"function"==typeof n&&n(),e.wasClean&&console.log(`[close] Connection closed cleanly, code=${e.code} reason=${e.reason}`),"function"==typeof PushcaClient.onCloseHandler&&PushcaClient.onCloseHandler(PushcaClient.ws,e)})},PushcaClient.stopWebSocket=function(){cleanRefreshBrokenConnectionInterval(),PushcaClient.ws&&PushcaClient.ws.readyState!==window.WebSocket.CLOSING&&PushcaClient.ws.readyState!==window.WebSocket.CLOSED&&PushcaClient.ws.close(3e3,"Stop websocket connection")},PushcaClient.stopWebSocketPermanently=function(){PushcaClient.permanentlyStopped=!0,PushcaClient.stopWebSocket()},PushcaClient.isOpen=function(){return!!PushcaClient.ws&&PushcaClient.ws.readyState===window.WebSocket.OPEN},PushcaClient.openWsConnection=async function(e,t,n,a,r=null){if(PushcaClient.permanentlyStopped)return;PushcaClient.serverBaseUrl=e,PushcaClient.ClientObj=t,PushcaClient.clientObjRefresher=n,a||initConnectionRecoveryInterval(e);let i=await getAuthorizedWsUrl(e,t,r);return WaiterResponseType.ERROR===i.type?(console.error(`cannot open authorized ws connection: url ${PushcaClient.wsUrl}, caused by`),void console.log(i.body)):i.body?(PushcaClient.wsUrl=i.body,await CallableFuture.callAsynchronously(3e3,null,(function(e){PushcaClient.openWebSocket((function(){CallableFuture.releaseWaiterIfExistsWithSuccess(e,window.WebSocket.OPEN)}),(function(t){CallableFuture.releaseWaiterIfExistsWithError(e,t)}),(function(){CallableFuture.releaseWaiterIfExistsWithError(e,window.WebSocket.CLOSED)}))}))):void console.error("Authorized ws url was not provided by Pushca server")},PushcaClient.restoreWsConnection=async function(e){if((!PushcaClient.ws||PushcaClient.ws.readyState!==window.WebSocket.OPEN)&&PushcaClient.ClientObj){let t,n=100;PushcaClient.ws&&PushcaClient.ws.readyState!==window.WebSocket.CLOSING&&PushcaClient.ws.readyState!==window.WebSocket.CLOSED&&(PushcaClient.ws.close(3e3,"Close broken connection before recovery"),n=2e3),await delay(n),t="function"==typeof PushcaClient.clientObjRefresher?PushcaClient.clientObjRefresher(PushcaClient.ClientObj):refreshClientObj(PushcaClient.ClientObj),await PushcaClient.openWsConnection(e,t,PushcaClient.clientObjRefresher,!0)}},PushcaClient.changeClientObject=function(e){if(PushcaClient.ws&&PushcaClient.ws.readyState===window.WebSocket.OPEN&&PushcaClient.ClientObj&&PushcaClient.ClientObj.equals(e))return null;const t=PushcaClient.ClientObj;return PushcaClient.ClientObj=e,PushcaClient.ws&&PushcaClient.ws.close(1e3,"leave"),t},PushcaClient.sendAcknowledge=function(e){let t={};t.messageId=e;let n=PushcaClient.buildCommandMessage(Command.ACKNOWLEDGE,t);PushcaClient.ws.send(n.message)},PushcaClient.sendGatewayRequest=async function(e,t,n){let a={};a.receiver=e.toJSON(!1),a.preserveOrder=!1,a.path=t,a.payload=byteArrayToBase64(n);let r=PushcaClient.buildCommandMessage(Command.SEND_GATEWAY_REQUEST,a),i=await PushcaClient.executeWithRepeatOnFailure(null,r,3e4);return WaiterResponseType.ERROR===i.type?(console.error("Failed send gateway request attempt: "+i.body),null):i.body},PushcaClient.sendGatewayResponse=function(e,t){let n={};n.id=e,n.payload=byteArrayToBase64(t);let a=PushcaClient.buildCommandMessage(Command.SEND_GATEWAY_RESPONSE,n);PushcaClient.ws.send(a.message)},PushcaClient.broadcastMessage=async function(e,t,n,a){let r={};r.id=e,r.filter=t,r.sender=PushcaClient.client,r.message=a,r.preserveOrder=n;let i=PushcaClient.buildCommandMessage(Command.SEND_MESSAGE,r),s=await PushcaClient.executeWithRepeatOnFailure(null,i);WaiterResponseType.ERROR===s.type&&console.error("Failed broadcast message attempt: "+s.body)},PushcaClient.sendMessageWithAcknowledge=async function(e,t,n,a){if(!allClientFieldsAreNotEmpty(t))return void console.error("Cannot broadcast with acknowledge: "+JSON.stringify(t));let r={};r.id=e,r.client=t,r.sender=PushcaClient.ClientObj,r.message=a,r.preserveOrder=n;let i=PushcaClient.buildCommandMessage(Command.SEND_MESSAGE_WITH_ACKNOWLEDGE,r),s=await PushcaClient.executeWithRepeatOnFailure(e,i);WaiterResponseType.ERROR===s.type&&console.error("Failed send message with acknowledge attempt: "+s.body)},PushcaClient.addMembersToChannel=async function(e,t){let n={};n.channel=e,n.filters=t;let a=PushcaClient.buildCommandMessage(Command.ADD_MEMBERS_TO_CHANNEL,n),r=await PushcaClient.executeWithRepeatOnFailure(null,a);return WaiterResponseType.ERROR!==r.type||(console.error("Failed add members to channel attempt: "+r.body),!1)},PushcaClient.sendMessageToChannel=async function(e,t,n){let a={};a.channel=e,isArrayNotEmpty(t)&&(a.mentioned=t),a.message=n;let r=PushcaClient.buildCommandMessage(Command.SEND_MESSAGE_TO_CHANNEL,a),i=await PushcaClient.executeWithRepeatOnFailure(null,r);return WaiterResponseType.ERROR===i.type?(console.error("Failed send message to channel attempt: "+i.body),null):MessageDetails.fromWsResponse(i.body)},PushcaClient.getChannelHistory=async function(e,t){let n={};n.channel=e,t&&(n.offset=t);let a=PushcaClient.buildCommandMessage(Command.GET_CHANNEL_HISTORY,n),r=await PushcaClient.executeWithRepeatOnFailure(null,a);return WaiterResponseType.ERROR===r.type?(console.error("Failed get channel history attempt: "+r.body),null):HistoryPage.fromWsResponse(r.body)},PushcaClient.removeMeFromChannel=async function(e){let t={};t.channel=e;let n=PushcaClient.buildCommandMessage(Command.REMOVE_ME_FROM_CHANNEL,t),a=await PushcaClient.executeWithRepeatOnFailure(null,n);return WaiterResponseType.ERROR===a.type&&console.error("Failed remove me from channel attempt: "+a.body),a},PushcaClient.getChannels=async function(e){let t={};t.filter=e;let n=PushcaClient.buildCommandMessage(Command.GET_CHANNELS,t),a=await PushcaClient.executeWithRepeatOnFailure(null,n);return WaiterResponseType.ERROR===a.type?(console.error("Failed get channels attempt: "+a.body),null):ChannelsResponse.fromWsResponse(a.body)},PushcaClient.getChannelsPublicInfo=async function(e){let t={};t.ids=e;let n=PushcaClient.buildCommandMessage(Command.GET_CHANNELS_PUBLIC_INFO,t),a=await PushcaClient.executeWithRepeatOnFailure(null,n);return WaiterResponseType.ERROR===a.type?(console.error("Failed get channels public info attempt: "+a.body),null):ChannelsResponse.fromWsResponse(a.body)},PushcaClient.markChannelAsRead=async function(e){let t={};t.channel=e;let n=PushcaClient.buildCommandMessage(Command.MARK_CHANNEL_AS_READ,t),a=await PushcaClient.executeWithRepeatOnFailure(null,n);WaiterResponseType.ERROR===a.type&&console.error("Failed mark channel as read attempt: "+a.body)},PushcaClient.getImpressionStat=async function(e){let t={};t.ids=e;let n=PushcaClient.buildCommandMessage(Command.GET_IMPRESSION_STAT,t),a=await PushcaClient.executeWithRepeatOnFailure(null,n);return WaiterResponseType.ERROR===a.type?(console.error("Failed get impression statistic attempt: "+a.body),null):ImpressionsResponse.fromWsResponse(a.body)},PushcaClient.addImpression=async function(e,t){let n={};n.channel=e,n.impression=t;let a=PushcaClient.buildCommandMessage(Command.ADD_IMPRESSION,n),r=await PushcaClient.executeWithRepeatOnFailure(null,a);WaiterResponseType.ERROR===r.type&&console.log("Failed add impression attempt: "+r.body)},PushcaClient.removeImpression=async function(e,t){let n={};n.channel=e,n.impression=t;let a=PushcaClient.buildCommandMessage(Command.REMOVE_IMPRESSION,n),r=await PushcaClient.executeWithRepeatOnFailure(null,a);WaiterResponseType.ERROR===r.type&&console.log("Failed add impression attempt: "+r.body)},PushcaClient.sendPing=function(){let e=PushcaClient.buildCommandMessage(Command.PING);PushcaClient.ws.send(e.message)},PushcaClient.sendUploadBinaryAppeal=async function(e,t,n,a,r){let i={};i.owner=e,i.binaryId=t,i.chunkSize=n,i.manifestOnly=a,i.requestedChunks=r;let s=PushcaClient.buildCommandMessage(Command.SEND_UPLOAD_BINARY_APPEAL,i),o=await PushcaClient.executeWithRepeatOnFailure(null,s);return WaiterResponseType.ERROR===o.type&&console.log("Failed send upload binary appeal attempt: "+o.body),o},PushcaClient.downloadBinaryChunk=async function(e,t,n,a){const r=calculateClientHashCode(PushcaClient.ClientObj.workSpaceId,PushcaClient.ClientObj.accountId,PushcaClient.ClientObj.deviceId,PushcaClient.ClientObj.applicationId),i=new ClientFilter(isStringPresentNumber(e.workSpaceId)?e.workSpaceId:`${calculateStringHashCode(e.workSpaceId)}`,e.accountId,null,e.applicationId),s=buildSingleChunkDownloadWaiterId(buildSharedFileChunkId(t,n,r)),o=await CallableFuture.callAsynchronouslyWithRepeatOfFailure(3e4,s,3,(function(){PushcaClient.sendUploadBinaryAppeal(i,t,a,!1,[n]).then((e=>{WaiterResponseType.ERROR===e.type&&CallableFuture.releaseWaiterIfExistsWithError(s,"Failed download binary chunk attempt: "+e.body)}))}));return WaiterResponseType.ERROR===o.type?(console.log(`Failed send chunk of binary with id ${t} and order = ${n} attempt: `+o.body),null):o.body},PushcaClient.sendDeleteBinaryAppeal=async function(e,t){let n={};n.binaryId=e,n.deviceSecret=t;let a=PushcaClient.buildCommandMessage(Command.SEND_DELETE_BINARY_APPEAL,n),r=await PushcaClient.executeWithRepeatOnFailure(null,a);return WaiterResponseType.ERROR===r.type?(console.log("Failed send delete binary appeal attempt: "+r.body),JSON.stringify({body:"false",error:r.body})):r.body},PushcaClient.sendBinaryManifest=async function(e,t){let n={};n.dest=e,n.manifest=t.toJSON();let a=PushcaClient.buildCommandMessage(Command.SEND_BINARY_MANIFEST,n),r=await PushcaClient.executeWithRepeatOnFailure(t.id,a);return WaiterResponseType.ERROR===r.type&&console.log(`Failed send manifest for binary with id ${t.id} attempt: `+r.body),r},PushcaClient.sendBinaryChunk=async function(e,t,n,a,r){if(isEmpty(PushcaClient.ws))return new WaiterResponse(WaiterResponseType.ERROR,"Web socket connection does not exists");if(PushcaClient.ws.readyState!==window.WebSocket.OPEN){const e=`WebSocket is not open. State: ${PushcaClient.ws.readyState}`;return console.error(e),new WaiterResponse(WaiterResponseType.ERROR,e)}const i=buildPushcaBinaryHeader(BinaryType.FILE,n,a,e,t),s=new ArrayBuffer(i.length+r.byteLength),o=new Uint8Array(s);o.set(i,0),o.set(new Uint8Array(r),i.length);const c=buildSharedFileChunkId(e,t,n),l=a?1:3,u=await CallableFuture.callAsynchronouslyWithRepeatOfFailure(6e4,c,l,(function(){PushcaClient.ws.send(s)}));return WaiterResponseType.ERROR===u.type&&console.log(`Failed send chunk of binary with id ${e} and order = ${t} attempt: `+u.body),u},PushcaClient.transferBinaryChunk=async function(e,t,n,a){if(isEmpty(PushcaClient.ws))return new WaiterResponse(WaiterResponseType.ERROR,"Web socket connection does not exists");if(PushcaClient.ws.readyState!==window.WebSocket.OPEN){const e=`WebSocket is not open. State: ${PushcaClient.ws.readyState}`;return console.error(e),new WaiterResponse(WaiterResponseType.ERROR,e)}const r=buildPushcaBinaryHeader(BinaryType.FILE_TRANSFER,n,!1,e,t),i=new ArrayBuffer(r.length+a.byteLength),s=new Uint8Array(i);s.set(r,0),s.set(new Uint8Array(a),r.length);const o=buildSharedFileChunkId(e,t,n),c=await CallableFuture.callAsynchronouslyWithRepeatOfFailure(2e4,o,3,(function(){PushcaClient.ws.send(i)}));return WaiterResponseType.ERROR===c.type&&console.log(`Failed send chunk of binary with id ${e} and order = ${t} attempt: `+c.body),c},PushcaClient.cacheBinaryChunkInCloud=async function(e,t,n){PushcaClient.isOpen()||await PushcaClient.restoreWsConnection();for(let e=0;e<300&&!PushcaClient.isOpen();e++)await delay(100);if(!PushcaClient.isOpen())return new WaiterResponse(WaiterResponseType.ERROR,"Web socket connection does not exists");if(PushcaClient.uploadBinaryLimitWasReached){const e=`WebSocket is not open. State: ${PushcaClient.ws.readyState}`;return console.error(e),new WaiterResponse(WaiterResponseType.ERROR,e)}const a=PushcaClient.ClientObj.hashCode(),r=buildPushcaBinaryHeader(BinaryType.CACHE_BINARY,a,!1,e,t),i=new ArrayBuffer(r.length+n.byteLength),s=new Uint8Array(i);s.set(r,0),s.set(new Uint8Array(n),r.length);const o=buildSharedFileChunkId(e,t,a),c=await CallableFuture.callAsynchronouslyWithRepeatOfFailure(2e4,o,3,(function(){PushcaClient.ws.send(i)}),!0);if(WaiterResponseType.ERROR===c.type){const n=`Failed cache in cloud  chunk of binary with id ${e} and order = ${t} attempt: ${c.body.body}`;console.log(n),isMobile()&&alert(n)}return c},PushcaClient.connectionAliasLookup=async function(e){let t={};t.fragment=e;let n=PushcaClient.buildCommandMessage(Command.CONNECTION_ALIAS_LOOKUP,t),a=await PushcaClient.executeWithRepeatOnFailure(null,n);if(WaiterResponseType.ERROR===a.type)return console.error("Failed connection alias lookup attempt: "+a.body),null;const r="string"==typeof a.body?JSON.parse(a.body):a.body;return r.error?(console.error("Failed connection alias lookup attempt: "+r.error),null):ClientWithAlias.fromObject(r)},PushcaClient.CaptchaVerify=async function(e,t,n,a){let r={};r.captchaId=e,r.pageId=t,r.resultIndex=n,a&&(r.backendUrl=e);let i=PushcaClient.buildCommandMessage(Command.CAPTCHA_VERIFY,r),s=await PushcaClient.executeWithRepeatOnFailure(null,i);WaiterResponseType.ERROR===s.type&&console.error("Failed verify captcha attempt: "+s.body)},PushcaClient.RequestPuzzleCaptcha=async function(e,t){let n={};n.captchaId=e,n.pieceSizeLength=t;let a=PushcaClient.buildCommandMessage(Command.PUZZLE_CAPTCHA_GENERATE_AND_SEND,n),r=await PushcaClient.executeWithRepeatOnFailure(null,a);WaiterResponseType.ERROR===r.type&&console.error("Failed request Puzzle captcha attempt: "+r.body)},PushcaClient.verifySelectedPieceOfPuzzleCaptcha=async function(e,t,n,a){let r={};r.captchaId=e,r.pageId=t,r.point={x:n,y:a};let i=PushcaClient.buildCommandMessage(Command.PUZZLE_CAPTCHA_VERIFY_SELECTED_OPTION,r),s=await PushcaClient.executeWithRepeatOnFailure(null,i,3e4);return WaiterResponseType.ERROR===s.type?(console.error("Failed verify selected piece of puzzle captcha attempt: "+s.body),null):s.body},PushcaClient.verifyPuzzleCaptcha=async function(e,t,n,a){let r={};r.captchaId=e,r.pageId=t,r.point={x:n,y:a};let i=PushcaClient.buildCommandMessage(Command.PUZZLE_CAPTCHA_VERIFY,r),s=await PushcaClient.executeWithRepeatOnFailure(null,i,3e4);if(WaiterResponseType.ERROR===s.type)return console.error("Failed verify selected piece of puzzle captcha attempt: "+s.body),null},window.addEventListener("beforeunload",(function(){cleanRefreshBrokenConnectionInterval(),isNotEmpty(PushcaClient.ws)&&PushcaClient.ws.close(1e3,"leave")}));const BinaryType=Object.freeze({FILE:0,MEDIA_STREAM:1,BINARY_MESSAGE:2,FILE_TRANSFER:3,CACHE_BINARY:4,PING:5,CAPTCHA_SET:6,PUZZLE_CAPTCHA_SET:7}),DatagramState=Object.freeze({UNKNOWN:0,LOADED:1,CORRUPTED:2});class Datagram{constructor(e,t,n){this.order=e,this.size=t,this.md5=n,this.state=DatagramState.UNKNOWN}setBytes(e){this.bytes=e,this.state=DatagramState.LOADED}setState(e){this.state=e}}class BinaryManifest{constructor(e,t,n,a,r,i,s,o,c,l,u,d,h,p,y,f){this.id=e,this.name=t,this.mimeType=n,this.readMeText=a,this.sender=r,this.pusherInstanceId=i,this.datagrams=isArrayNotEmpty(s)?s:[],this.totalSize=o,this.created=c||(new Date).getTime(),this.password=l,this.privateUrlSuffix=u,this.downloadCounter=d||0,this.base64Key=h,this.base64IV=p,this.cachedInCloud=y,this.forHuman=f}getPrivateUrlShortSuffix(){return this.privateUrlSuffix?this.privateUrlSuffix.split("@@")[0]:null}getPrivateUrlLongSuffix(){if(!this.privateUrlSuffix)return null;const e=this.privateUrlSuffix.split("@@");return e.length>1?e[1]:null}getTotalSize(){return this.totalSize||(this.totalSize=calculateTotalSize(this.datagrams)),this.totalSize}resetTotalSize(){this.totalSize=null}appendDatagram(e){this.resetTotalSize(),this.datagrams.push(e),this.totalSize=calculateTotalSize(this.datagrams)}setSender(e){this.sender=e}setPusherInstanceId(e){this.pusherInstanceId=e}getPublicUrl(e,t){const n=PushcaClient.clusterBaseUrl;let a;if(this.password){const r=t?`?workspace=${e}`:"";a=`${n}/binary/${this.getPrivateUrlShortSuffix()}${r}`}else a=`${n}/public-binary-ex.html?w=${e}&id=${this.id}&tn=${buildThumbnailId(this.id)}`,this.forHuman&&(a=`${a}&human-only=true`);return a}async setChunkBytes(e,t){const n=this.datagrams[e];return CallableFuture.callAsynchronously(2e3,null,(function(a){calculateSha256(t).then((r=>{n.md5===r?(n.setBytes(t),CallableFuture.releaseWaiterIfExistsWithSuccess(a,!0)):(console.warn(`Corrupted chunk was received: binary id = ${this.id}, order = ${e}`),n.setState(DatagramState.CORRUPTED),CallableFuture.releaseWaiterIfExistsWithError(a,!1))}))}))}isCompleted(){return this.datagrams.every((e=>e.state===DatagramState.LOADED))}isFinalized(){return this.datagrams.every((e=>e.state!==DatagramState.UNKNOWN))}isExpired(){return(new Date).getTime()-this.created>18e5}toJSON(){return{id:this.id,name:this.name,mimeType:this.mimeType,readMeText:this.readMeText,sender:this.sender,pusherInstanceId:this.pusherInstanceId,datagrams:this.datagrams}}toDbJSON(){return{id:this.id,name:this.name,mimeType:this.mimeType,readMeText:this.readMeText,sender:this.sender,pusherInstanceId:this.pusherInstanceId,datagrams:this.datagrams,password:this.password,privateUrlSuffix:this.privateUrlSuffix,base64Key:this.base64Key,base64IV:this.base64IV,cachedInCloud:this.cachedInCloud,forHuman:this.forHuman}}static fromObject(e,t,n,a){const r=new ClientFilter(e.sender.workSpaceId,e.sender.accountId,e.sender.deviceId,e.sender.applicationId);let i=[];return isArrayNotEmpty(e.datagrams)&&(i=e.datagrams.map((e=>new Datagram(e.order,e.size,e.md5)))),new BinaryManifest(e.id,e.name,e.mimeType,e.readMeText,r,e.pusherInstanceId,i,t,n,e.password,e.privateUrlSuffix,a,e.base64Key,e.base64IV,e.cachedInCloud,e.forHuman)}static fromJSON(e,t,n,a){const r="string"==typeof e?JSON.parse(e):e;return this.fromObject(r,t,n,a)}}class BinaryWithHeader{constructor(e){this.binaryType=bytesToShortInt(copyBytes(e,0,1)),this.destClientHash=bytesToInt(copyBytes(e,1,5)),this.withAcknowledge=bytesToBoolean(copyBytes(e,5,6)),this.binaryId=bytesToUuid(copyBytes(e,6,22)),this.order=bytesToInt(copyBytes(e,22,26)),this.payload=copyBytes(e,26,e.byteLength)}getId(){return buildSharedFileChunkId(this.binaryId,this.order,this.destClientHash)}}const BinaryWaitingHall=new Map;function buildSharedFileChunkId(e,t,n){return`${e}-${t}-${n}`}async function manifestToJsonObjectWithProtectedAttributes(e){let t=null;if(e.base64Key){const n=new EncryptionContract(e.base64Key,e.base64IV),a=stringToByteArray(Fileshare.workSpaceId);t=await n.toTransferableString(e.password,a)}const n=e.password?await calculateSha256(stringToArrayBuffer(e.password)):null;return{id:e.id,name:e.name,mimeType:e.mimeType,readMeText:e.readMeText,sender:e.sender,pusherInstanceId:e.pusherInstanceId,datagrams:e.datagrams,privateUrlSuffix:e.privateUrlSuffix,encryptionContract:t,passwordHash:n,deviceSecret:Fileshare.deviceSecret,forHuman:e.forHuman}}async function getPrivateUrlSuffix(e){let t=null;const n=await CallableFuture.callAsynchronously(2e3,null,(function(t){getManifestByRecordId(e,(function(e){CallableFuture.releaseWaiterIfExistsWithSuccess(t,e)}),(function(e){CallableFuture.releaseWaiterIfExistsWithError(t,e.target.error)}))}));if(WaiterResponseType.SUCCESS===n.type&&n.body){const e=n.body;if(e.base64Key){t=(await manifestToJsonObjectWithProtectedAttributes(e)).encryptionContract}return{privateUrlSuffix:e.getPrivateUrlLongSuffix(),encryptionContract:t}}return null}async function addBinaryToStorage(e,t,n,a,r,i){let s;if(!i)return console.log(`Binary manifest was not provided: ${t}`),null;if(0===r&&(s=await CallableFuture.callAsynchronously(2e3,null,(function(e){saveBinaryManifest(i,(function(){CallableFuture.releaseWaiterIfExistsWithSuccess(e,!0)}),(function(t){showErrorMsg(t.target.error.message,null),CallableFuture.releaseWaiterIfExistsWithError(e,!1)}))})),WaiterResponseType.ERROR===s.type))return null;const o=splitArrayBuffer(a,MemoryBlock.MB);for(let a=0;a<o.length;a++){const s=100*r+a,c=await addChunkToBinaryManifest(i,s,o[a]);if(WaiterResponseType.SUCCESS!==c.type||!c.body)return console.log(`Cannot append binary chunk: name ${t}, order ${s}`),null;i=c.body;const l=new Blob([o[a]],{type:n});saveBinaryChunk(e,s,l),await PushcaClient.cacheBinaryChunkInCloud(e,s,o[a])}return s=await CallableFuture.callAsynchronously(2e3,null,(function(e){saveBinaryManifest(i,(function(){CallableFuture.releaseWaiterIfExistsWithSuccess(e,!0)}),(function(t){showErrorMsg(`Failed attempt to store manifest of binary with name ${i.name}: ${t.target.error.message}`,null),removeAllRecordsWithBinaryId(i.id),CallableFuture.releaseWaiterIfExistsWithError(e,!1)}))})),WaiterResponseType.ERROR===s.type?(console.log(`Failed Save manifest attempt during binary upload: file name = ${t}`),null):i}async function createBinaryManifest(e,t,n,a,r,i,s,o,c){if(!PushcaClient.ClientObj)return new WaiterResponse(WaiterResponseType.ERROR,"Owner connection is absent");const l=new ClientFilter(PushcaClient.ClientObj.workSpaceId,PushcaClient.ClientObj.accountId,PushcaClient.ClientObj.deviceId,PushcaClient.ClientObj.applicationId);if(!r){const i=new BinaryManifest(e,t,n,a,l,PushcaClient.pusherInstanceId,[],null,null,r,null,null,null,null,s,o);return new WaiterResponse(WaiterResponseType.SUCCESS,i)}const u=c||Fileshare.workSpaceId;return await CallableFuture.callAsynchronously(2e3,null,(function(c){createPrivateUrlSuffix(u,e).then((u=>{const d=new BinaryManifest(e,t,n,a,l,PushcaClient.pusherInstanceId,[],null,null,r,u,null,i?i.base64Key:null,i?i.base64IV:null,s,o);CallableFuture.releaseWaiterIfExistsWithSuccess(c,d)}))}))}async function addChunkToBinaryManifest(e,t,n){return await CallableFuture.callAsynchronously(2e3,null,(function(a){chunk2Datagram(t,n,(function(t){t?(e.appendDatagram(t),CallableFuture.releaseWaiterIfExistsWithSuccess(a,e)):CallableFuture.releaseWaiterIfExistsWithError(a,"Cannot convert bytes to datagram")}))}))}async function chunkToDatagram(e,t){return await CallableFuture.callAsynchronously(2e3,null,(function(n){chunk2Datagram(e,t,(function(e){e?CallableFuture.releaseWaiterIfExistsWithSuccess(n,e):CallableFuture.releaseWaiterIfExistsWithError(n,"Cannot convert bytes to datagram")}))}))}function chunk2Datagram(e,t,n){t&&0!==t.byteLength?calculateSha256(t).then((a=>{"function"==typeof n&&n(new Datagram(e,t.byteLength,a))})):"function"==typeof n&&n(null)}function calculateClientHashCode(e,t,n,a){return calculateStringHashCode(formatString("{0}@@{1}@@{2}@@{3}",e,t,n,a))}function buildPushcaBinaryHeader(e,t,n,a,r){return concatenateByteArrays(shortIntToBytes(e),intToBytes(t),booleanToBytes(n),uuidToBytes(a),intToBytes(r))}function extractOrderFromBinaryWithHeader(e){return bytesToInt(copyBytes(e,22,26))}function calculateTotalSize(e){return isArrayNotEmpty(e)?e.reduce(((e,t)=>e+t.size),0):0}async function saveBinaryManifestToDatabase(e){return await CallableFuture.callAsynchronously(2e3,null,(function(t){saveBinaryManifest(e,(function(){CallableFuture.releaseWaiterIfExistsWithSuccess(t,!0)}),(function(e){const n=e.target.error?e.target.error.message:"Unknown error";CallableFuture.releaseWaiterIfExistsWithError(t,n)}))}))}async function saveBinaryChunkToDatabase(e,t,n){return await CallableFuture.callAsynchronously(2e3,null,(function(a){saveBinaryChunk(e,t,n,(function(){CallableFuture.releaseWaiterIfExistsWithSuccess(a,!0)}),(function(e){const t=e.target.error?e.target.error.message:"Unknown error";CallableFuture.releaseWaiterIfExistsWithError(a,t)}))}))}async function processUploadBinaryAppeal(e){const t=new ClientFilter(e.sender.workSpaceId,e.sender.accountId,e.sender.deviceId,e.sender.applicationId);sendBinary(e.binaryId,e.manifestOnly,e.requestedChunks,t)}async function sendBinary(e,t,n,a){const r=calculateClientHashCode(a.workSpaceId,a.accountId,a.deviceId,a.applicationId);if(isArrayNotEmpty(n)){for(let t=0;t<n.length;t++)await retrieveAndSendBinaryChunk(e,n[t],r,!1);return}let i,s=await CallableFuture.callAsynchronously(2e3,null,(function(t){getManifest(e,(function(e){CallableFuture.releaseWaiterIfExistsWithSuccess(t,e)}),(function(e){CallableFuture.releaseWaiterIfExistsWithError(t,e.target.error)}))}));if(WaiterResponseType.SUCCESS===s.type&&s.body&&(i=s.body),i){if(i.setPusherInstanceId(PushcaClient.pusherInstanceId),i.setSender(PushcaClient.ClientObj),t)return await PushcaClient.sendBinaryManifest(a,i),void incrementDownloadCounterOfManifestRecord(i.id);for(let t=0;t<i.datagrams.length;t++)await retrieveAndSendBinaryChunk(e,t,r,!0);console.log(`Successfully send binary with id ${e}`)}else console.warn(`Unknown binary with id ${e}`)}async function retrieveAndSendBinaryChunk(e,t,n,a){const r=await CallableFuture.callAsynchronously(2e3,null,(function(n){getBinaryChunk(e,t,(function(e){CallableFuture.releaseWaiterIfExistsWithSuccess(n,e)}))}));if(WaiterResponseType.ERROR===r.type||!r.body)return void console.warn(`Chunk ${t} of binary with id ${e} not found`);const i=await r.body.arrayBuffer();return await PushcaClient.sendBinaryChunk(e,t,n,a,i)}function buildDownloadWaiterId(e){return`wd_${e}`}function buildSingleChunkDownloadWaiterId(e){return`wds_${e}`}function downloadBinary(e,t,n){downloadFile(new Blob(e,{type:n}),t)}async function loadAllBinaryChunks(e,t,n){const a=[];let r=0;for(;r<t;){const t=await loadBinaryChunk(e,r);if(WaiterResponseType.SUCCESS!==t.type||!t.body)return void console.error(`Binary data is corrupted or cannot be loaded: binaryId = ${e}, order = ${r}`);a.push(t.body),r+=1}"function"==typeof n&&n(a)}async function loadBinaryChunk(e,t){return await CallableFuture.callAsynchronously(3e3,null,(function(n){getBinaryChunk(e,t,(function(e){CallableFuture.releaseWaiterIfExistsWithSuccess(n,e)}))}))}const CaptchaConfig={SERVER_URL:"https://secure.fileshare.ovh",WS_URL:"wss://secure.fileshare.ovh:31085",BRAND_URL:"https://sl-st.com",WORKSPACE_ID:"SecureFileShare",ACCOUNT_ID:"dynamic-captcha",APP_ID:"PUZZLE_CAPTCHA_APP",HINT_DISPLAY_DURATION:2e3,RELOAD_DELAY:1500,VERIFICATION_DELAY:2e3,STATE_UPDATE_DELAY:10,LOAD_CHECK_INTERVAL:100,CAPTCHA_TIMEOUT:6e5,IMAGE_LOAD_DELAY:300,DOUBLE_TAP_THRESHOLD:300,MAX_LOAD_ATTEMPTS:50,MIN_PIECE_LENGTH:300,DEFAULT_PIECE_LENGTH:300,DESKTOP_PIECE_OFFSET_X:100,DESKTOP_PIECE_OFFSET_Y:100,MOBILE_PIECE_OFFSET_X:200,MOBILE_PIECE_OFFSET_Y:200,IOS_PIECE_OFFSET_X:80,IOS_PIECE_OFFSET_Y:80,THROTTLE_FPS:60,THROTTLE_MS:16,MOBILE_WIDTH_THRESHOLD:500,MOBILE_TOUCH_POINTS:1,MOUSE_POINTER_ID:1,DOM_IDS:{CANVAS:"puzzleCaptchaArea",PIECE:"selectedCaptchaPiece",ERROR:"errorMessage",BRAND:"brandNameDiv",HINT:"captchaHint"},MESSAGES:{TASK_HINT:"Task: find matching shapes and drag one onto its pair to align them.",ERROR:"You can try better next time!",SUCCESS:"Your Human token was assigned. Amazing job!",WRONG_PIECE:"Wrong piece selected, reloading"}};class DeviceDetector{static isMobile(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)||navigator.maxTouchPoints&&navigator.maxTouchPoints>CaptchaConfig.MOBILE_TOUCH_POINTS||window.innerWidth<=CaptchaConfig.MOBILE_WIDTH_THRESHOLD}static isIOS(){return/iPhone|iPad|iPod/i.test(navigator.userAgent)||navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)}static getEventCoordinates(e){let t,n;return e.touches&&e.touches.length>0?(t=e.touches[0].clientX,n=e.touches[0].clientY):e.changedTouches&&e.changedTouches.length>0?(t=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY):(t=e.clientX||e.pageX,n=e.clientY||e.pageY),{x:t,y:n}}static createSyntheticPointerEvent(e,t){return new PointerEvent(e,{bubbles:!0,cancelable:!0,isPrimary:!0,pointerId:CaptchaConfig.MOUSE_POINTER_ID,pointerType:"mouse",clientX:t.clientX,clientY:t.clientY,isTrusted:t.isTrusted})}static createSyntheticPointerEventFromTouch(e,t){const n=t.touches?t.touches[0]:t.changedTouches[0];return new PointerEvent(e,{bubbles:!0,cancelable:!0,isPrimary:!0,pointerId:n.identifier+2,pointerType:"touch",clientX:n.clientX,clientY:n.clientY,isTrusted:t.isTrusted})}}class TimeUtils{static delay(e){return new Promise((t=>setTimeout(t,e)))}}class URLParamParser{constructor(){this.params=new URLSearchParams(window.location.search)}get(e){return this.params.get(e)}has(e){return this.params.has(e)}getInt(e,t){const n=this.params.get(e);return n?parseInt(n,10):t}}class CaptchaState{constructor(e){this.captchaId=uuid.v4().toString(),this.pageId=e.get("page-id")||uuid.v4().toString(),this.backendUrl=e.get("backend-url"),this.embedded=e.has("page-id");const t=e.getInt("piece-length",CaptchaConfig.DEFAULT_PIECE_LENGTH);this.pieceLength=Math.max(t,CaptchaConfig.MIN_PIECE_LENGTH),this.showTask=!0,this.skipDemo=!0,this.loaded=!1,this.blocked=!1,this.isVerifying=!1,this.correctOptionWasSelected=!1,this.startPoint={x:0,y:0},this.pieceStartPoint={x:0,y:0}}markLoaded(){this.loaded=!0}setStartPoint(e,t){this.startPoint={x:e,y:t}}setPieceStartPoint(e,t){this.pieceStartPoint={x:e,y:t}}setVerifying(e){this.isVerifying=e}setCorrectOptionSelected(e){this.correctOptionWasSelected=e}reset(){this.correctOptionWasSelected=!1,this.isVerifying=!1}}class DragState{constructor(){this.isDragging=!1,this.activePointerId=null,this.lastMoveTime=0,DeviceDetector.isIOS()?(this.pieceOffsetX=CaptchaConfig.IOS_PIECE_OFFSET_X,this.pieceOffsetY=CaptchaConfig.IOS_PIECE_OFFSET_Y):DeviceDetector.isMobile()?(this.pieceOffsetX=CaptchaConfig.MOBILE_PIECE_OFFSET_X,this.pieceOffsetY=CaptchaConfig.MOBILE_PIECE_OFFSET_Y):(this.pieceOffsetX=CaptchaConfig.DESKTOP_PIECE_OFFSET_X,this.pieceOffsetY=CaptchaConfig.DESKTOP_PIECE_OFFSET_Y)}startDrag(e){this.isDragging=!0,this.activePointerId=e}endDrag(){this.isDragging=!1,this.activePointerId=null}shouldThrottle(){const e=Date.now();return e-this.lastMoveTime<CaptchaConfig.THROTTLE_MS||(this.lastMoveTime=e,!1)}isActivePointer(e){return e===this.activePointerId}}class UIManager{constructor(e){this.canvas=e.canvas,this.piece=e.piece,this.errorMsg=e.errorMsg,this.brand=e.brand}showPiece(e,t,n,a){this.piece.style.display="block",this.piece.style.left=e-n+"px",this.piece.style.top=t-a+"px",this.piece.style.pointerEvents="none"}hidePiece(){this.piece.style.display="none",this.piece.style.pointerEvents="none"}updatePiecePosition(e,t,n,a){requestAnimationFrame((()=>{this.piece.style.left=e-n+"px",this.piece.style.top=t-a+"px"}))}updatePiecePositionDirect(e,t,n,a){this.piece.style.left=e-n+"px",this.piece.style.top=t-a+"px"}addDraggingClass(){document.body.classList.add("dragging")}removeDraggingClass(){document.body.classList.remove("dragging")}hideCanvas(){this.canvas.style.display="none"}showError(e,t=null){t&&(this.errorMsg.style.color=t),this.errorMsg.textContent=e,this.errorMsg.style.display="block"}showBrand(){this.brand.style.display="flex"}getPieceRect(){return this.piece.getBoundingClientRect()}loadPieceImage(e){return new Promise(((t,n)=>{this.piece.src=e,this.piece.onload=()=>{URL.revokeObjectURL(e),t()},this.piece.onerror=()=>{URL.revokeObjectURL(e),n(new Error("Failed to load piece image"))}}))}loadCanvasImage(e){const t=this.canvas.getContext("2d"),n=new Image;return new Promise(((a,r)=>{n.onload=()=>{this.canvas.width=n.naturalWidth,this.canvas.height=n.naturalHeight,this.canvas.style.width=`${n.naturalWidth}px`,this.canvas.style.height=`${n.naturalHeight}px`,t.drawImage(n,0,0),URL.revokeObjectURL(e),a()},n.onerror=()=>{URL.revokeObjectURL(e),r(new Error("Failed to load canvas image"))},n.src=e}))}getCanvasRelativeCoordinates(e,t){const n=this.canvas.getBoundingClientRect();return{x:e-n.left,y:t-n.top}}}class StyleManager{static injectCompatibilityStyles(){const e=document.createElement("style");e.textContent=`\n            #${CaptchaConfig.DOM_IDS.CANVAS} {\n                touch-action: none;\n                -webkit-user-select: none;\n                user-select: none;\n                -webkit-touch-callout: none;\n                -webkit-tap-highlight-color: transparent;\n            }\n            #${CaptchaConfig.DOM_IDS.PIECE} {\n                touch-action: manipulation;\n                -webkit-user-select: none;\n                user-select: none;\n                -webkit-touch-callout: none;\n                -webkit-tap-highlight-color: transparent;\n                pointer-events: none;\n            }\n            body.dragging {\n                overflow: hidden;\n                -webkit-overflow-scrolling: auto;\n            }\n            * {\n                -webkit-touch-callout: none;\n                -webkit-user-select: none;\n                -khtml-user-select: none;\n                -moz-user-select: none;\n                -ms-user-select: none;\n                user-select: none;\n            }\n        `,document.head.appendChild(e)}static initializeMobileSettings(){if(!DeviceDetector.isMobile())return;document.body.style.touchAction="none",document.body.style.userSelect="none",document.body.style.webkitUserSelect="none",document.body.style.webkitTouchCallout="none";let e=0;document.addEventListener("touchend",(t=>{const n=Date.now();n-e<=CaptchaConfig.DOUBLE_TAP_THRESHOLD&&t.preventDefault(),e=n}),!1),document.addEventListener("touchstart",(e=>{e.touches.length>1&&e.preventDefault()}),{passive:!1}),document.addEventListener("gesturestart",(e=>{e.preventDefault()}),{passive:!1})}}class DragController{constructor(e,t,n,a){this.captchaState=e,this.dragState=t,this.ui=n,this.verificationCallback=a,this.targetElement=null}handlePointerDown(e,t=null){if(!1===e.isPrimary||!e.isTrusted||this.dragState.isDragging)return;if(!this.captchaState.correctOptionWasSelected)return;if(this.dragState.startDrag(e.pointerId),this.ui.addDraggingClass(),this.targetElement=t,t&&t.setPointerCapture)try{t.setPointerCapture(e.pointerId),console.log("Pointer captured:",e.pointerId)}catch(e){console.warn("Could not capture pointer:",e)}const{x:n,y:a}=DeviceDetector.getEventCoordinates(e);this.ui.showPiece(n,a,this.dragState.pieceOffsetX,this.dragState.pieceOffsetY);const r=this.ui.getPieceRect();this.captchaState.setPieceStartPoint(r.left,r.top),this.captchaState.setCorrectOptionSelected(!1),e.preventDefault(),e.stopPropagation()}handlePointerMove(e){if(!this.dragState.isActivePointer(e.pointerId)||!e.isTrusted||!this.dragState.isDragging)return;if(!("touch"===e.pointerType||DeviceDetector.isMobile())&&this.dragState.shouldThrottle())return;const{x:t,y:n}=DeviceDetector.getEventCoordinates(e);this.ui.updatePiecePositionDirect(t,n,this.dragState.pieceOffsetX,this.dragState.pieceOffsetY),e.preventDefault(),e.stopPropagation()}handlePointerUp(e){if(!this.dragState.isActivePointer(e.pointerId)||!this.dragState.isDragging||!e.isTrusted)return;if(this.targetElement&&this.targetElement.releasePointerCapture)try{this.targetElement.releasePointerCapture(e.pointerId),console.log("Pointer released:",e.pointerId)}catch(e){}this.dragState.endDrag(),this.ui.removeDraggingClass();const t=this.ui.getPieceRect();this.ui.hidePiece();const n=Math.round(this.captchaState.startPoint.x+(t.left-this.captchaState.pieceStartPoint.x)),a=Math.round(this.captchaState.startPoint.y+(t.top-this.captchaState.pieceStartPoint.y));console.log("Drag completed at:",{x:n,y:a}),this.verifyDragPosition(n,a),e.preventDefault(),e.stopPropagation()}async verifyDragPosition(e,t){await TimeUtils.delay(CaptchaConfig.STATE_UPDATE_DELAY);try{await this.verificationCallback(e-this.dragState.pieceOffsetX,t-this.dragState.pieceOffsetY)}catch(e){console.error("Verification error:",e)}}handleTouchCancel(){if(this.dragState.isDragging){if(this.targetElement&&this.targetElement.releasePointerCapture&&this.dragState.activePointerId)try{this.targetElement.releasePointerCapture(this.dragState.activePointerId)}catch(e){}this.dragState.endDrag(),this.ui.removeDraggingClass(),this.ui.hidePiece()}}}class CanvasInteractionController{constructor(e,t,n,a,r,i){this.captchaState=e,this.dragState=t,this.ui=n,this.dragController=a,this.verificationCallback=r,this.failureCallback=i}createClickHandler(){return async e=>{if(!this.captchaState.isVerifying&&!this.dragState.isDragging&&e.isPrimary){this.captchaState.setVerifying(!0);try{const{x:t,y:n}=DeviceDetector.getEventCoordinates(e),{x:a,y:r}=this.ui.getCanvasRelativeCoordinates(t,n);this.captchaState.setStartPoint(a,r),console.log("Canvas click detected at:",{x:a,y:r});const i=await this.verificationCallback(a,r);if(this.captchaState.setCorrectOptionSelected(i),console.log("Verification result:",i),e.preventDefault(),e.stopPropagation(),i){const a=new PointerEvent("pointerdown",{bubbles:!0,cancelable:!0,isPrimary:!0,pointerId:e.pointerId||(e.touches?e.touches[0].identifier:CaptchaConfig.MOUSE_POINTER_ID),pointerType:e.pointerType||(e.touches?"touch":"mouse"),clientX:t,clientY:n,isTrusted:e.isTrusted});this.dragController.handlePointerDown(a,e.target||this.ui.canvas)}else console.log(CaptchaConfig.MESSAGES.WRONG_PIECE),this.failureCallback(!0)}catch(e){console.error("Piece selection error:",e),this.captchaState.setCorrectOptionSelected(!1),this.failureCallback(!0)}finally{this.captchaState.setVerifying(!1)}}}}}class EventCoordinator{constructor(e){this.dragController=e,this.passiveOptions={passive:!1}}setupPointerEvents(){DeviceDetector.isIOS()?console.log("iOS detected - using touch events instead of pointer events"):(document.addEventListener("pointerdown",(e=>this.dragController.handlePointerDown(e,e.target)),this.passiveOptions),document.addEventListener("pointermove",(e=>this.dragController.handlePointerMove(e)),this.passiveOptions),document.addEventListener("pointerup",(e=>this.dragController.handlePointerUp(e)),this.passiveOptions),document.addEventListener("pointercancel",(e=>this.dragController.handlePointerUp(e)),this.passiveOptions))}setupTouchFallbacks(e){const t=DeviceDetector.isIOS();document.addEventListener("touchstart",(e=>{if(t&&this.dragController.captchaState.correctOptionWasSelected){const t=DeviceDetector.createSyntheticPointerEventFromTouch("pointerdown",e);return this.dragController.handlePointerDown(t,e.target),void e.preventDefault()}this.dragController.captchaState.correctOptionWasSelected&&!1!==e.isPrimary&&e.preventDefault()}),this.passiveOptions),document.addEventListener("touchmove",(n=>{if(t&&e.isDragging){const e=DeviceDetector.createSyntheticPointerEventFromTouch("pointermove",n);return this.dragController.handlePointerMove(e),void n.preventDefault()}e.isDragging&&n.preventDefault()}),this.passiveOptions),document.addEventListener("touchend",(n=>{if(t&&e.isDragging){const e=DeviceDetector.createSyntheticPointerEventFromTouch("pointerup",n);return this.dragController.handlePointerUp(e),void n.preventDefault()}e.isDragging&&n.preventDefault()}),this.passiveOptions),document.addEventListener("touchcancel",(t=>{e.isDragging&&(this.dragController.handleTouchCancel(),t.preventDefault())}),this.passiveOptions)}setupMouseFallbacks(e){document.addEventListener("mousedown",(e=>{const t=DeviceDetector.createSyntheticPointerEvent("pointerdown",e);this.dragController.handlePointerDown(t,e.target)}),this.passiveOptions),document.addEventListener("mousemove",(t=>{if(!e.isDragging)return;const n=DeviceDetector.createSyntheticPointerEvent("pointermove",t);this.dragController.handlePointerMove(n)}),this.passiveOptions),document.addEventListener("mouseup",(t=>{if(!e.isDragging)return;const n=DeviceDetector.createSyntheticPointerEvent("pointerup",t);this.dragController.handlePointerUp(n)}),this.passiveOptions)}setupPreventionHandlers(e){document.addEventListener("contextmenu",(t=>{e.isDragging&&t.preventDefault()})),document.addEventListener("selectstart",(t=>{e.isDragging&&t.preventDefault()})),document.addEventListener("dragstart",(e=>{e.preventDefault()}))}setupAllEventListeners(e){this.setupPointerEvents(),this.setupTouchFallbacks(e),this.setupMouseFallbacks(e),this.setupPreventionHandlers(e)}}class WebSocketAdapter{constructor(e,t){this.state=e,this.client=t}async verifyPieceSelection(e,t){const n=await this.client.verifySelectedPieceOfPuzzleCaptcha(this.state.captchaId,this.state.pageId,e,t);return"true"===JSON.parse(n).body}async verifyDragPosition(e,t){await this.client.verifyPuzzleCaptcha(this.state.captchaId,this.state.pageId,e,t)}async requestPuzzle(){await this.client.RequestPuzzleCaptcha(this.state.captchaId,this.state.pieceLength)}isOpen(){return this.client.isOpen()}stop(){this.client.stopWebSocket()}async connect(){if(this.isOpen())return;const e=new ClientFilter(CaptchaConfig.WORKSPACE_ID,CaptchaConfig.ACCOUNT_ID,this.state.embedded?uuid.v4().toString():this.state.pageId,CaptchaConfig.APP_ID);await this.client.openWsConnection(CaptchaConfig.WS_URL,e,(e=>new ClientFilter(e.workSpaceId,e.accountId,e.deviceId,e.applicationId)))}}class PuzzleCaptchaApp{constructor(){this.elements={canvas:document.getElementById(CaptchaConfig.DOM_IDS.CANVAS),piece:document.getElementById(CaptchaConfig.DOM_IDS.PIECE),errorMsg:document.getElementById(CaptchaConfig.DOM_IDS.ERROR),brand:document.getElementById(CaptchaConfig.DOM_IDS.BRAND)},this.urlParser=new URLParamParser,this.captchaState=new CaptchaState(this.urlParser),this.dragState=new DragState,this.uiManager=new UIManager(this.elements),this.wsAdapter=new WebSocketAdapter(this.captchaState,PushcaClient),this.dragController=new DragController(this.captchaState,this.dragState,this.uiManager,((e,t)=>this.handleDragVerification(e,t))),this.canvasController=new CanvasInteractionController(this.captchaState,this.dragState,this.uiManager,this.dragController,((e,t)=>this.wsAdapter.verifyPieceSelection(e,t)),(e=>this.reloadOnFail(e))),this.eventCoordinator=new EventCoordinator(this.dragController),this.setupWebSocketHandlers()}async initialize(){StyleManager.injectCompatibilityStyles(),StyleManager.initializeMobileSettings(),this.eventCoordinator.setupAllEventListeners(this.dragState),this.elements.brand&&this.elements.brand.addEventListener("click",(()=>{window.open(CaptchaConfig.BRAND_URL,"_blank")})),TimeUtils.delay(CaptchaConfig.CAPTCHA_TIMEOUT).then((()=>{this.reloadOnFail(!0)}))}async handleDragVerification(e,t){await this.wsAdapter.verifyDragPosition(e,t),await TimeUtils.delay(CaptchaConfig.VERIFICATION_DELAY),this.wsAdapter.isOpen()&&this.reloadOnFail(!0)}reloadOnFail(e){this.wsAdapter.stop(),e&&(this.uiManager.hideCanvas(),this.uiManager.showError(CaptchaConfig.MESSAGES.ERROR)),TimeUtils.delay(CaptchaConfig.RELOAD_DELAY).then((()=>{const e=new URL(window.location.href);e.searchParams.set("hide-task","true"),window.location.href=e.toString()}))}setupWebSocketHandlers(){PushcaClient.onOpenHandler=async()=>{await this.wsAdapter.requestPuzzle();let e=0;for(;!this.captchaState.loaded;)if(await TimeUtils.delay(CaptchaConfig.LOAD_CHECK_INTERVAL),e++,e>CaptchaConfig.MAX_LOAD_ATTEMPTS)return void this.reloadOnFail(!1);await TimeUtils.delay(CaptchaConfig.IMAGE_LOAD_DELAY)},PushcaClient.onHumanTokenHandler=e=>{console.log(`Human token received: ${e}`),this.wsAdapter.stop(),this.uiManager.hideCanvas(),this.uiManager.showError(CaptchaConfig.MESSAGES.SUCCESS,"green"),this.captchaState.embedded,TimeUtils.delay(CaptchaConfig.RELOAD_DELAY).then((()=>{location.reload()}))},PushcaClient.onPuzzleCaptchaSetHandler=async e=>{const t=new Blob([e.payload],{type:"image/png"}),n=URL.createObjectURL(t);if(this.captchaState.loaded)await this.uiManager.loadPieceImage(n);else{await this.uiManager.loadCanvasImage(n);const e=this.canvasController.createClickHandler();this.elements.canvas.addEventListener("pointerdown",e,{passive:!1}),this.elements.canvas.addEventListener("touchstart",e,{passive:!1}),this.elements.canvas.addEventListener("mousedown",e,{passive:!1}),this.captchaState.markLoaded(),console.log("Puzzle image loaded successfully")}}}async start(){this.elements.brand.title=CaptchaConfig.MESSAGES.TASK_HINT;const e=document.getElementById(CaptchaConfig.DOM_IDS.HINT);if(!this.captchaState.showTask)return e&&e.remove(),this.uiManager.showBrand(),void await this.wsAdapter.connect();this.captchaState.skipDemo&&(this.uiManager.showBrand(),e&&(e.style.display="flex",await TimeUtils.delay(CaptchaConfig.HINT_DISPLAY_DURATION),e.remove()),await this.wsAdapter.connect())}}let captchaApp;function initializeApplication(){captchaApp=new PuzzleCaptchaApp,captchaApp.initialize()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeApplication):initializeApplication(),window.addEventListener("DOMContentLoaded",(async()=>{captchaApp&&await captchaApp.start()}));